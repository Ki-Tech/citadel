# Makefile for Citadel/UX
#
# NOTE: normally you should not have to modify the Makefile.  All
# system-dependent configuration is in the "configure" script, which
# uses "Makefile.in" to generate a "Makefile".  In the rare instance
# that you have to modify something here, please take note:
# 1. Edit Makefile.in, -not- Makefile.
# 2. Send e-mail to ajc@uncensored.citadel.org and let me know what you
#    did, so any necessary changes can be put into the next release.
#
# $Id$
#
########################################################################

TARGETS=@TARGETS@
CHKPWD=@CHKPWD@

all: $(TARGETS)

.SUFFIXES: .lo .d .c

EXEEXT=@EXEEXT@

SMTP=@SMTP@

CLIENT_TARGETS=citadel$(EXEEXT) whobbs$(EXEEXT)
SERVER_TARGETS=libcitserver.la citserver setup $(CHKPWD)
SERV_MODULES=modules/libchat.la modules/libvcard.la \
	modules/libupgrade.la \
	$(SMTP) \
	modules/libpop3.la \
	modules/libimap.la \
	modules/libnetwork.la \
	modules/libnetfilter.la \
	modules/libpas2.la \
	modules/libinetcfg.la \
	modules/librwho.la \
	modules/libmoderate.la \
	modules/libbio.la \
	modules/libexpire.la \
	modules/libvandelay.la \
	modules/libical.la
UTIL_TARGETS=aidepost netsetup msgform readlog \
	stats citmail userlist sendcommand \
	base64 migratenet$(EXEEXT)

prefix=@prefix@
srcdir=@srcdir@

AUTH=@AUTH@
DEFS=@DEFS@
CPPFLAGS=@CPPFLAGS@ -I.
CFLAGS=@CFLAGS@
CC=@CC@
RESOLV=@RESOLV@
LIBS=@LIBS@
LDFLAGS=@LDFLAGS@
chkpwd_LIBS=@chkpwd_LIBS@
LIBOBJS=@LIBOBJS@
INSTALL=@INSTALL@
INSTALL_DATA=@INSTALL_DATA@
SHELL=/bin/sh
AUTOCONF=@AUTOCONF@
ACLOCAL=@ACLOCAL@
YACC=@YACC@
DATABASE=@DATABASE@

LIBTOOL=./libtool
LTSHARE=cd modules && ../$(LIBTOOL) $(CC) -rpath $(prefix)/modules -no-undefined -avoid-version -module

# End configuration section

VPATH=$(srcdir)

DOMAIN=@DOMAIN@

SOURCES=aidepost.c citadel.c citmail.c citserver.c client_chat.c \
	client_crypto.c commands.c config.c control.c $(DATABASE) \
	dynloader.c file_ops.c housekeeping.c ipc_c_tcp.c locate_host.c \
	logging.c messages.c msgbase.c msgform.c \
	netsetup.c policy.c readlog.c migratenet.c screen.c \
	room_ops.c rooms.c routines.c routines2.c serv_chat.c serv_crypto.c \
	serv_info.c serv_test.c setup.c snprintf.c stats.c serv_vcard.c \
	support.c sysdep.c tools.c user_ops.c userlist.c serv_expire.c \
	whobbs.c sendcommand.c mime_parser.c base64.c getutline.c \
	auth.c chkpwd.c html.c vcard.c serv_upgrade.c serv_vandelay.c \
	serv_smtp.c serv_pop3.c internet_addressing.c parsedate.c genstamp.c \
	$(DOMAIN) clientsocket.c serv_inetcfg.c serv_rwho.c serv_bio.c \
	serv_moderate.c client_passwords.c imap_misc.c serv_netfilter.c \
	serv_imap.c imap_tools.c imap_fetch.c imap_search.c imap_store.c \
	serv_network.c serv_pas2.c serv_ical.c md5.c server_main.c

DEP_FILES=$(SOURCES:.c=.d)

client: $(CLIENT_TARGETS)

server: $(SERVER_TARGETS)

utils: $(UTIL_TARGETS)

serv_modules: $(SERV_MODULES)
	@cd modules && mods=`echo .libs/*.s[ol]` && test "$$mods" != '.libs/*.s[ol]' && ln -sf $$mods . || true
	@cd modules && mods=`echo .libs/*.dll` && test "$$mods" != '.libs/*.dll' && ln -sf $$mods . || true

#
#

citadel$(EXEEXT): ipc_c_tcp.o citadel.o rooms.o routines.o \
	routines2.o messages.o screen.o \
	client_passwords.o md5.o client_crypto.o \
	commands.o client_chat.o serv_info.o tools.o $(LIBOBJS)
	$(CC) ipc_c_tcp.o citadel.o rooms.o routines.o \
	routines2.o messages.o screen.o \
	commands.o client_chat.o serv_info.o tools.o \
	client_passwords.o md5.o client_crypto.o \
	$(LIBOBJS) $(LDFLAGS) -o citadel $(LIBS)

.y.c:
	$(YACC) $(YFLAGS) $<
	mv -f y.tab.c $@

#
#

SERV_OBJS = server_main.o

parsedate.o: parsedate.c

LIBSERV_OBJS = user_ops.lo citserver.lo sysdep.lo dynloader.lo tools.lo $(DATABASE:.c=.lo) \
	control.lo policy.lo config.lo support.lo room_ops.lo file_ops.lo msgbase.lo \
	locate_host.lo housekeeping.lo logging.lo mime_parser.lo html.lo internet_addressing.lo \
	serv_crypto.lo parsedate.lo genstamp.lo clientsocket.lo $(AUTH) $(LIBOBJS:.o=.lo)

libcitserver.la: $(LIBSERV_OBJS)
	$(LIBTOOL) $(CC) $(LDFLAGS) -rpath $(prefix) -no-undefined -avoid-version \
	-o libcitserver.la $(LIBSERV_OBJS) $(LIBS) $(RESOLV)

citserver: $(SERV_OBJS) $(LIBTOOL) libcitserver.la
	$(LIBTOOL) --mode=link $(CC) $(SERV_OBJS) $(LDFLAGS) libcitserver.la -o \
	citserver $(LIBS)

.c.o:
	$(CC) $(CFLAGS) $(CPPFLAGS) $(DEFS) -DCIT_CLIENT -c $< -o $@

.c.lo: $(LIBTOOL)
	@test -d modules || mkdir -p modules
	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) $(CPPFLAGS) $(DEFS) -c $< -o $@

modules/libchat.la: serv_chat.lo libcitserver.la $(LIBTOOL)
	$(LTSHARE) -o libchat.la ../serv_chat.lo ../libcitserver.la

modules/libtest.la: serv_test.lo libcitserver.la $(LIBTOOL)
	$(LTSHARE) -o libtest.la ../serv_test.lo ../libcitserver.la

modules/libpop3.la: serv_pop3.lo md5.lo $(LIBTOOL) libcitserver.la
	$(LTSHARE) -o libpop3.la ../serv_pop3.lo ../md5.lo ../libcitserver.la

modules/libinetcfg.la: serv_inetcfg.lo $(LIBTOOL) libcitserver.la
	$(LTSHARE) -o libinetcfg.la ../serv_inetcfg.lo ../libcitserver.la

modules/librwho.la: serv_rwho.lo $(LIBTOOL) libcitserver.la
	$(LTSHARE) -o librwho.la ../serv_rwho.lo ../libcitserver.la

modules/libmoderate.la: serv_moderate.lo $(LIBTOOL) libcitserver.la
	$(LTSHARE) -o libmoderate.la ../serv_moderate.lo ../libcitserver.la

modules/libbio.la: serv_bio.lo $(LIBTOOL) libcitserver.la
	$(LTSHARE) -o libbio.la ../serv_bio.lo ../libcitserver.la

modules/libexpire.la: serv_expire.lo $(LIBTOOL) libcitserver.la
	$(LTSHARE) -o libexpire.la ../serv_expire.lo ../libcitserver.la

modules/libvandelay.la: serv_vandelay.lo $(LIBTOOL) libcitserver.la
	$(LTSHARE) -o libvandelay.la ../serv_vandelay.lo ../libcitserver.la

modules/libnetwork.la: serv_network.lo $(LIBTOOL) libcitserver.la
	$(LTSHARE) -o libnetwork.la ../serv_network.lo ../libcitserver.la

modules/libnetfilter.la: serv_netfilter.lo $(LIBTOOL) libcitserver.la
	$(LTSHARE) -o libnetfilter.la ../serv_netfilter.lo ../libcitserver.la

modules/libupgrade.la: serv_upgrade.lo $(LIBTOOL) libcitserver.la
	$(LTSHARE) -o libupgrade.la ../serv_upgrade.lo ../libcitserver.la

modules/libvcard.la: serv_vcard.lo vcard.lo $(LIBTOOL) libcitserver.la
	$(LTSHARE) -o libvcard.la ../serv_vcard.lo ../vcard.lo ../libcitserver.la

modules/libsmtp.la: serv_smtp.lo domain.lo $(LIBTOOL) libcitserver.la
	$(LTSHARE) -o libsmtp.la ../serv_smtp.lo ../domain.lo ../libcitserver.la


modules/libimap.la: serv_imap.lo imap_tools.lo imap_fetch.lo \
	imap_search.lo imap_store.lo imap_misc.lo $(LIBTOOL) libcitserver.la
	$(LTSHARE) -o libimap.la ../imap_tools.lo ../serv_imap.lo \
		../imap_fetch.lo ../imap_search.lo ../imap_store.lo ../imap_misc.lo ../libcitserver.la

aidepost: aidepost.o libcitserver.la $(LIBOBJS)
	$(LIBTOOL) $(CC) aidepost.o libcitserver.la $(LIBOBJS) $(LDFLAGS) -o aidepost $(LIBS)

modules/libpas2.la: serv_pas2.lo md5.lo $(LIBTOOL) libcitserver.la
	$(LTSHARE) -o libpas2.la ../serv_pas2.lo ../md5.lo ../libcitserver.la

modules/libical.la: serv_ical.lo $(LIBTOOL) libcitserver.la
	$(LTSHARE) -o libical.la ../serv_ical.lo ../libcitserver.la

citmail: citmail.o config.o
	$(CC) citmail.o config.o $(LDFLAGS) -o citmail $(LIBS)

setup: setup.o tools.o
	$(CC) setup.o tools.o $(LIBS) $(LDFLAGS) -o setup

chkpwd: chkpwd.o auth.o config.o
	$(CC) chkpwd.o auth.o config.o $(LDFLAGS) -o chkpwd $(chkpwd_LIBS)

netsetup: netsetup.o config.o
	$(CC) netsetup.o config.o $(LDFLAGS) -o netsetup

whobbs$(EXEEXT): whobbs.o ipc_c_tcp.o tools.o client_crypto.o $(LIBOBJS)
	$(CC) whobbs.o ipc_c_tcp.o tools.o client_crypto.o $(LIBOBJS) $(LDFLAGS) -o whobbs $(LIBS)

migratenet$(EXEEXT): migratenet.o config.o ipc_c_tcp.o client_crypto.o tools.o libcitserver.la $(LIBOBJS)
	$(LIBTOOL) $(CC) migratenet.o config.o ipc_c_tcp.o client_crypto.o tools.o libcitserver.la $(LIBOBJS) $(LDFLAGS) -o migratenet $(LIBS)

sendcommand: sendcommand.o ipc_c_tcp.o client_crypto.o libcitserver.la $(LIBOBJS)
	$(LIBTOOL) $(CC) sendcommand.o ipc_c_tcp.o client_crypto.o libcitserver.la \
	 $(LIBOBJS) $(LDFLAGS) -o sendcommand $(LIBS)

base64: base64.o
	$(CC) base64.o $(LDFLAGS) -o base64

userlist: userlist.o ipc_c_tcp.o client_crypto.o tools.o $(LIBOBJS)
	$(CC) userlist.o ipc_c_tcp.o client_crypto.o tools.o \
	$(LIBOBJS) $(LDFLAGS) -o userlist $(LIBS)

msgform: msgform.o
	$(CC) msgform.o $(LDFLAGS) -o msgform

readlog: readlog.o config.o
	$(CC) readlog.o config.o $(LDFLAGS) -o readlog

stats: stats.o ipc_c_tcp.o client_crypto.o libcitserver.la $(LIBOBJS)
	$(LIBTOOL) $(CC) stats.o ipc_c_tcp.o client_crypto.o libcitserver.la $(LIBOBJS) $(LDFLAGS) -o stats $(LIBS)

.PHONY: install-data install-doc install-exec clean cleaner distclean

install: install-exec install-data install-doc

install-data:
	@for i in help messages network/spoolin network/spoolout \
		 network/systems; do \
		$(srcdir)/mkinstalldirs $(root)$(prefix)/$$i; \
	done
	@for i in citadel.rc public_clients \
		 `find $(srcdir)/help $(srcdir)/messages $(srcdir)/network -type f | grep -v CVS`; do \
		echo $(INSTALL_DATA) $$i $(root)$(prefix)/$$i; \
		$(INSTALL_DATA) $$i $(root)$(prefix)/$$i; \
	done
	-@if test -d $(root)/etc/pam.d; then \
		echo $(INSTALL_DATA) $(srcdir)/citadel.pam $(root)/etc/pam.d/citadel; \
		$(INSTALL_DATA) $(srcdir)/citadel.pam $(root)/etc/pam.d/citadel; \
	fi

install-doc:
	@$(srcdir)/mkinstalldirs $(root)$(prefix)/techdoc
	@for i in `find $(srcdir)/techdoc -type f | grep -v CVS`; do \
		echo $(INSTALL_DATA) $$i $(root)$(prefix)/$$i; \
		$(INSTALL_DATA) $$i $(root)$(prefix)/$$i; \
	done

install-exec: all weekly
	@for i in bio bitbucket files images info modules userpics; do \
		$(srcdir)/mkinstalldirs $(root)$(prefix)/$$i; \
	done
	@for i in $(CLIENT_TARGETS) $(SERVER_TARGETS) $(UTIL_TARGETS); do \
		if test -f $$i; then \
			echo $(LIBTOOL) --mode=install $(INSTALL) $$i $(root)$(prefix)/$$i; \
			$(LIBTOOL) --mode=install $(INSTALL) $$i $(root)$(prefix)/$$i; \
		fi \
	done
	@for i in $(SERV_MODULES) ; do \
		if test -f $$i; then \
			(cd modules && ../$(LIBTOOL) --mode=install $(INSTALL) `basename $$i` $(root)$(prefix)/$$i) ; \
		fi \
	done
	@for i in utilsmenu weekly dnetsetup; do \
		if test -f $(srcdir)/$$i; then \
			echo $(INSTALL) $(srcdir)/$$i $(root)$(prefix)/$$i; \
			$(INSTALL) $(srcdir)/$$i $(root)$(prefix)/$$i; \
		fi \
	done
	@if test x`find $(root)$(prefix)/chkpwd -user root` = x$(root)$(prefix)/chkpwd; then \
		echo chmod u+s $(root)$(prefix)/chkpwd; \
		chmod u+s $(root)$(prefix)/chkpwd; \
	fi

clean:
	rm -f *.o *.lo parsedate.c

cleaner: clean
	rm -rf $(CLIENT_TARGETS) $(SERVER_TARGETS) $(UTIL_TARGETS) \
		modules/*.la modules/.libs so_locations

distclean: cleaner
	find . -name '*~' -o -name '.#*' | xargs rm -f
	rm -f Makefile sysdep.h config.cache config.log config.status *.d weekly

.c.d:
	@echo Checking dependencies for $<
	@$(CC) -M $(CPPFLAGS) $< | sed -e 's!$*.o!$*.o $*.lo $@!' > $@
	@test -s $@ || rm -f $@

Makefile: $(srcdir)/Makefile.in config.status
	CONFIG_FILES=Makefile CONFIG_HEADERS= $(SHELL) ./config.status

config.status: $(srcdir)/configure
	$(SHELL) ./config.status --recheck

$(srcdir)/configure: $(srcdir)/configure.ac $(srcdir)/aclocal.m4
	cd $(srcdir) && $(AUTOCONF)

$(srcdir)/aclocal.m4: $(srcdir)/acinclude.m4
	cd $(srcdir) && $(ACLOCAL)

weekly: $(srcdir)/weekly.in config.status
	CONFIG_FILES=weekly CONFIG_HEADERS= $(SHELL) ./config.status

LIBTOOL_DEPS = @LIBTOOL_DEPS@
$(LIBTOOL): $(LIBTOOL_DEPS)
	$(SHELL) ./config.status --recheck

-include $(DEP_FILES)
