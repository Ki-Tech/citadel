 $Log$
 Revision 591.49  2002/06/19 21:52:13  ajc
 * Support a transient room create as well

 Revision 591.48  2002/06/19 21:42:57  ajc
 * Added support for "transient goto" which allows entry into a private and/or
   zapped room without putting the room [back] on your known rooms list.  This
   is useful for the new administrative functions in WebCit (updating a user's
   vCard without the Aide suddenly having that user's config room on their
   list).  It's also useful for making a certain pedophile in Sacramento even
   more suspicious that someone is reading his email.

 Revision 591.47  2002/06/18 16:34:06  error
 * room_ops.c: Fix for old room record not being deleted when renaming
   baseroom or aideroom

 Revision 591.46  2002/06/16 21:01:11  ajc
 * Allow Aides to create rooms in other users' namespaces (if global access
   controls allow)

 Revision 591.45  2002/06/15 20:48:50  ajc
 * Fixed small bug in the e<X>pert mode toggle

 Revision 591.44  2002/06/15 20:14:55  ajc
 * Fixed a memory allocation bug in the vCard parser

 Revision 591.43  2002/06/15 17:53:59  error
 * citserver.c: MESG command can now send a different system message based
   on the developer and client ID of the connected client

 Revision 591.42  2002/06/15 04:52:26  ajc
 * SpamAssassin connector is now configurable in <.A>ide <S>ysconfig <I>nternet.
 * Allow more than one SA server (it'll try 'em all)
 * Don't run SA for logged in users

 Revision 591.41  2002/06/14 20:42:56  ajc
 * Discovered that spamd works even without the Content-length: command, so I
   was able to redo the spam checker to work without a temp file.

 Revision 591.40  2002/06/14 20:37:03  ajc
 * Disabled the spam strings checker I wrote a few days ago.
 * When receiving SMTP, check to see if spamd (the SpamAssassin daemon) is
   running on the local machine.  If yes, run the message through it and
   reject if spam.

 Revision 591.39  2002/06/12 03:42:21  ajc
 * "Suppress message prompts" has been changed to "Prompt after each message"
   and of course the effect has been reversed.
 * "Be unlisted in userlog" has been moved to the end of the list of
   configuration prompts, so it doesn't interrupt the flow of thought regarding
   the prompting questions.

 Revision 591.38  2002/06/10 22:25:25  ajc
 * Configuration for spam filter

 Revision 591.37  2002/06/09 23:59:38  ajc
 * Started working on the spam filter

 Revision 591.36  2002/06/07 22:10:51  ajc
 * Added a new message function hook type EVT_SMTPSCAN which permits modules to
   register hooks that can scan incoming SMTP messages and elect to reject them
   (due to virus or spam content, for example).

 Revision 591.35  2002/06/07 03:22:13  ajc
 * Added a module "serv_mrtg" which allows activity reporting to MRTG
   (http://www.mrtg.org) -- this will replace our stats program.

 Revision 591.34  2002/06/02 16:42:17  error
 * Support for Ctrl-W to erase a word when editing or at a prompt

 Revision 591.33  2002/05/31 18:34:04  nbryant
 better curses compatibility, and a couple makefile/configure tweaks

 Revision 591.32  2002/05/28 13:59:02  ajc
 * Removed the 'netsetup' and 'dnetsetup' utilities (obsolete)

 Revision 591.31  2002/05/24 19:58:13  ajc
 * Fixed the "idle timeout during paginator prompt" bug by reintroducting the
   concept of a "half keepalive" and sending them during paginator prompts.

 Revision 591.30  2002/05/23 03:33:21  ajc
 * Added a GTSN (GeT list of SeeN messages) command

 Revision 591.29  2002/05/20 14:29:59  ajc
 * commands.c: fixed bug in the scan for idle_threshold= which didn't include
   the = sign and ended up always setting this value to 0

 Revision 591.28  2002/05/17 03:57:30  ajc
 * When doing fixed_output() of converted HTML, output the whole block of
   data at once instead of one character at a time

 Revision 591.27  2002/05/16 04:44:58  ajc
 * Reduce the number of socket writes when doing fixed_output() to avoid
   getting killed by overhead.  (Thanks to IO for the insight)

 Revision 591.26  2002/05/14 15:25:34  error
 * room_ops.c: clarified aide message when room aide is removed

 Revision 591.25  2002/05/14 15:18:43  error
 * rooms.c: Print name of room aide if any when doing <i>nfo

 Revision 591.24  2002/05/14 01:33:18  error
 * Fixed some incredibly silly typos

 Revision 591.23  2002/05/14 01:27:18  error
 * Minor cosmetic changes, extraneous double spaces etc.

 Revision 591.22  2002/05/14 01:15:54  error
 * Idle threshold on the who list is now customizable in the citadel.rc

 Revision 591.21  2002/05/14 01:09:57  error
 * citadel.c: spacebar won't read New if there are no new messages

 Revision 591.20  2002/05/12 23:00:11  ajc
 * Removed an unused variable

 Revision 591.19  2002/05/12 22:57:04  ajc
 * Removed the unfinished moderation system.
 * CtdlForEachMessage() - only fetch metadata when hunting for messages with
   a specified Content-type.  Serious performance boost.

 Revision 591.18  2002/05/05 17:33:09  error
 * screen.c: fix lack of beeps in curses mode

 Revision 591.17  2002/05/04 02:58:16  ajc
 * Documented a small protocol change for the STEL command

 Revision 591.16  2002/04/30 03:13:59  ajc
 * When sending a page that results in the receiver's Sent/Received Pages>
   room to be created, don't automatically grant the sender access to that room.
 * Added a parameter to create_room() to implement the above

 Revision 591.15  2002/04/23 13:38:08  ajc
 * Minor docs update

 Revision 591.14  2002/04/21 21:28:06  ajc
 * Create the My Citadel Config> room along with the user account

 Revision 591.13  2002/04/20 03:00:01  ajc
 * One more fix for the RENAME command wrt namespaces.

 Revision 591.12  2002/04/18 18:44:36  nbryant
 don't use libtool -avoid-version for libcitserver - this might help for
 OpenBSD

 Revision 591.11  2002/04/17 04:35:06  ajc
 * Finished the IMAP RENAME command.  (I ended up using nested functions
   because it made the task much, much easier.  We can fix it later or convert
   it to C++ if we find this becomes a problem.)

 Revision 591.10  2002/04/15 13:25:47  ajc
 * Add error responses to imap_rename() and set up subfolder framework

 Revision 591.9  2002/04/14 22:42:49  ajc
 * Began implementing RENAME command in IMAP.

 Revision 591.8  2002/04/14 22:27:05  ajc
 * Added access control checking to CtdlRenameRoom()

 Revision 591.7  2002/04/14 22:11:22  ajc
 * New back end function CtdlRenameRoom() which is used to rename a room and/or
   move it to a different floor.
 * cmd_setr() now uses CtdlRenameRoom() to do part of its work

 Revision 591.6  2002/04/10 03:58:40  ajc
 * Began work on IMAP RENAME

 Revision 591.5  2002/04/09 14:26:43  ajc
 * Allow INBOX to have subfolders.  There's no longer any reason not to.

 Revision 591.4  2002/04/05 22:31:59  error
 * Send time-of-day with pages sent via IMAP

 Revision 591.3  2002/04/05 14:34:02  ajc
 * Minor tweak to nested folder algorithm to handle nesting in mail root

 Revision 591.2  2002/04/05 04:25:56  ajc
 * Support nested folders in IMAP.  We might want to change the delimiter.

 Revision 591.1  2002/04/04 23:25:30  ajc
 * Experimental hacking to handle subfolderization in IMAP.  Seems to work ok
   but it makes Mozilla mail hang.  Will investigate more later...

 Revision 591.0  2002/04/01 05:13:20  ajc
 * Tagged everything for 5.91 release

 Revision 590.168  2002/04/01 05:12:57  ajc
 * Prep for 5.91 release

 Revision 590.167  2002/03/29 04:43:15  ajc
 * Removed the BMBX command.  Mailbox security update now runs automatically when the
   server starts and it sees data files version <5.91.

 Revision 590.166  2002/03/26 05:58:35  nbryant
 don't check for a database driver until after the openssl check is
 complete. if the ld paths aren't set up for the db installation this
 can interfere with the openssl check because it tries to run a program
 linked against the libraries we've been finding.

 Revision 590.165  2002/03/26 05:20:46  nbryant
 removed last vestiges of "#ifdef CIT_CLIENT" conditional compilation,
 which has been rendered unusable by the build system simplifications

 Revision 590.164  2002/03/26 05:13:32  nbryant
 fix monstrous shell script syntax in configure.ac

 Revision 590.163  2002/03/26 04:38:31  nbryant
  * support autoconf 2.53
  * make a note that people should be using libtool 1.4d
  * cut some of the more pointless bells and whistles out of the configure
    script in an effort to make it more maintainable
  * modularized ipc_c_tcp.c and client_crypto.o so that they're not tied
    to the curses stuff.
  * timezone/daylight and other FreeBSD fixes
  * more effort in the configure script to detect the common
    bastardizations (ahem, ports) of Berkeley DB without falling down

 Revision 590.162  2002/03/25 03:09:39  nbryant
 fix warning on platforms where pthread_t may be a pointer

 Revision 590.161  2002/03/25 00:01:50  nbryant
  * compatibility with Berkeley DB < 3.3
  * squished symbol clashes with the OK symbol from curses in certain *n[iu]x
 distributions. this is kind of a pain in the ass, but I had to rename our
 OK to CIT_OK :-(

 Revision 590.160  2002/03/22 04:35:38  ajc
 * Handle vCard registration updates for users other than the one currently
   logged in.  (Allows administrative editing of contact information.)

 Revision 590.159  2002/03/20 19:03:27  ajc
 * Don't re-declare timezone variables ('cuz FreeBSD chokes on that)

 Revision 590.158  2002/03/19 04:34:42  ajc
 * mime_parser.c: minor changes for easier porting between Citadel and WebCit

 Revision 590.157  2002/03/19 04:19:33  ajc
 * Saw what IO did with strchr() and did the same in a few more places

 Revision 590.156  2002/03/17 00:08:02  error
 * mime_parser.c: more robust parsing of Content-Type header

 Revision 590.155  2002/03/16 05:22:59  ajc
 * Post an error message to Aide> when unlink() is unable to delete old
   database log files.

 Revision 590.154  2002/03/14 04:35:26  nbryant
 avoid symbol clash with curses' "timeout" function (which may be a macro
 in some versions)

 Revision 590.153  2002/03/14 04:24:20  nbryant
 support window resizing in curses mode

 Revision 590.152  2002/03/13 04:11:11  nbryant
 fix up minor gotcha introduced by fgets change

 Revision 590.151  2002/03/13 03:58:29  ajc
 * Site-configurable option "Allow system Aides to gain access to mailboxes"

 Revision 590.150  2002/03/13 03:34:38  nbryant
 /* when running in curses mode, the scroll bar in most
    xterm-style programs becomes useless, so it makes sense to
    pause after a screenful of pages if the user has been idle
    for a while. However, this is annoying to some of the users
    who aren't in curses mode and tend to leave their clients
    idle. keepalives become disabled, resulting in getting booted
    when coming back to the idle session. but they probably have
    a working scrollback in their terminal, so disable it in this
    case:
  */
 if (!is_curses_enabled())
 	lines_printed = 0;

 Revision 590.149  2002/03/12 23:34:37  nbryant
 use ncurses in preference to curses if it's installed; it handles
 background colors properly on dtterm, has a larger color pair palette,
 and has a bigger terminal database than solaris curses

 Revision 590.148  2002/03/12 22:47:17  nbryant
 curses fix: map our normal color pairs into the 0-7 range instead of 1-8,
 in order to make our pairs fit on terminals such as dtterm where COLOR_PAIRS=8.
 map the white/blue color pair onto 8 instead of 9, but only if that slot
 is available; fall back on white/black otherwise.

 it seems there may be an off-by-one error in the color pair manpages for
 the various curses packages (?) if not, our 0 entry is unusable, but that's
 the DIM_BLACK color and we don't use it anyway.

 Revision 590.147  2002/03/12 22:17:20  ajc
 * Give mailbox owners access to "who knows room" command

 Revision 590.146  2002/03/12 21:08:03  nbryant
 support color under Solaris curses

 Revision 590.145  2002/03/12 19:59:40  ajc
 * Access control change: do not treat mailboxes as guessname rooms for Aides.
   Open up INVT/KICK commands to non-Aides for their mailboxes.

 Revision 590.144  2002/03/12 04:30:52  nbryant
 if a filesystem node exists at /var/run/egd-pool, try to connect to it as
 the EGD (Entropy Gathering Daemon) or PRNGD (pseudorandom number
 generator daemon) socket and seed OpenSSL's RNG.

 this is necessary on solaris and other systems which lack /dev/urandom.

 Revision 590.143  2002/03/12 03:43:26  nbryant
 squished the last remaining calls to sprintf

 Revision 590.142  2002/03/12 03:36:55  nbryant
 replace calls to gets with fgets

 Revision 590.141  2002/03/12 03:19:09  nbryant
 more sprintf bashing. now the only ones left are in mime_parser

 Revision 590.140  2002/03/12 01:33:42  nbryant
  - pass -Wcast-qual to gcc
  - more sprintf bashing

 Revision 590.139  2002/03/12 00:03:43  nbryant
 more sprintf removals

 Revision 590.138  2002/03/11 06:00:21  nbryant
 use <db.h> before <db3/db.h> or <db4/db.h>
 this is the only way i can think of to make it work everywhere; people on
 systems like FreeBSD where the ports work the other way around will have to
 specify an extra -I flag in their CPPFLAGS variable.

 Revision 590.137  2002/03/11 05:42:46  nbryant
 removed all references to sprintf from several files (not all files yet)
 and replace with snprintf

 Revision 590.136  2002/03/11 04:16:20  nbryant
 warning fixes on sparc-sun-solaris2.8 with gcc 3.0.4, mostly for *printf
 format strings

 Revision 590.135  2002/03/11 03:55:24  nbryant
  - fixes for building without OpenSSL
  - setenv doesn't exist on all systems, use putenv instead
  - support Solaris' curses implementation

 Revision 590.134  2002/03/09 22:52:04  ajc
 * Applied a patch submitted by <xperc@hotmail.com> to fix a potential buffer
   overflow problem in lprintf().  I also did the same fix to cprintf().

 Revision 590.133  2002/03/09 16:47:57  ajc
 * Added BMBX to fix a problem

 Revision 590.132  2002/03/09 06:18:37  ajc
 * one more tweak

 Revision 590.131  2002/03/09 05:22:29  ajc
 * this should do it.

 Revision 590.130  2002/03/09 05:02:20  ajc
 * Attempts to fix the access control crap

 Revision 590.129  2002/03/08 05:42:02  ajc
 * Patch to allow invitations and admin access to mailbox rooms.  NEEDS TESTING!

 Revision 590.128  2002/03/07 04:30:37  ajc
 * Force recipient only in Mail>, not in all mailbox rooms

 Revision 590.127  2002/03/05 22:45:40  error
 * Autoconf fixes for DB4 support

 Revision 590.126  2002/03/05 04:47:49  ajc
 * vcard.c: another API update

 Revision 590.125  2002/03/04 05:29:39  ajc
 * Made a small API change to vcard.c for WebCit, brought the change over here too
   in order to keep vcard.c identical everywhere.

 Revision 590.124  2002/03/03 06:48:25  ajc
 * Client and server options to disable self-service user account creation

 Revision 590.123  2002/03/03 06:31:58  ajc
 * Added password starred-out entry to newprompt() and strprompt()
 * Applied the above setting to password set/change in <.A>ide <U>seredit

 Revision 590.122  2002/03/03 06:18:45  ajc
 * Implemented the CREU server command to administratively create user accounts
 * Added the ability to create new user accounts to <.A>ide <U>seredit

 Revision 590.121  2002/03/03 06:05:16  ajc
 * Split up some of the code in order to prepare for user accounts to be
   administratively created without logging in to them.

 Revision 590.120  2002/03/02 05:56:48  ajc
 * Properly implemented the network filter list.  Finished the server module and
   did a client-side <.A>ide <S>ysconfig <F>ilterlist command.

 Revision 590.119  2002/03/01 04:24:20  ajc
 * Cosmetic change to Received: line

 Revision 590.118  2002/03/01 04:16:22  ajc
 * CtdlReadMessageBody() -- fixed bug that caused the prepend buffer to be
   discarded instead of prepended.  "Received:" lines now work.

 Revision 590.117  2002/02/23 19:20:51  ajc
 * Do the use table purge in two phases to avoid crashy crashy

 Revision 590.116  2002/02/20 22:42:19  ajc
 * Started adding better management of source IP addressses in SMTP service

 Revision 590.115  2002/02/15 04:28:57  ajc
 * Wrote the expire/purge routine for the new use table

 Revision 590.114  2002/02/15 04:05:08  ajc
 * Began implementation of a networker use table that doesn't chew up oodles
   of CPU time.  (It uses a cdb instead.)

 Revision 590.113  2002/02/15 03:40:06  ajc
 * Stu's changes (which he checked in without making any ChangeLog comments,
   bad Stu!) didn't build properly without curses.  Added #ifdef's.

 Revision 590.112  2002/02/13 22:15:10  ajc
 * That was stupid.

 Revision 590.111  2002/02/13 22:04:11  ajc
 * added vcard_to_html() function

 Revision 590.110  2002/02/13 15:48:55  ajc
 * Allow the READ command to return packets bigger than 1 byte.  (ooops!)

 Revision 590.109  2002/02/12 20:15:25  ajc
 * Threw in a few more #ifdef's so the client build doesn't barf on
   non-curses systems
 * Added rc_prompt_control (<N>ext/<S>top active at paginator: on/off/user)

 Revision 590.108  2002/02/11 15:52:10  ajc
 * Don't crash when deleting "purge this vCard" messages

 Revision 590.107  2002/02/10 22:36:41  nbryant
  - replace cdb_trunc with a complete version of the code i had been
    working on; fallback code for db < 3.3.x needed
  - change 'can't connect to host.port' to 'can't connect to host:port'

 Revision 590.106  2002/02/08 22:39:08  ajc
 * If there's already a Subject line in memory, display it below the usual
   headers when the user hits <E>

 Revision 590.105  2002/02/08 22:36:23  ajc
 * Changed the logic for printing RFC822 addresses (again)
 * Implemented cdb_trunc() in database_sleepycat.c, using db_truncate()
   (We need to either provide an alternative implementation or require DB >=3.3)
 * Automatically Re: subject line in the client where appropriate

 Revision 590.104  2002/02/08 19:02:25  ajc
 * Added client and server side support for entering Subject lines in
   messages when not using RFC822.

 Revision 590.103  2002/02/08 18:10:07  ajc
 * When outputting a message in non-RFC822 format, don't display an Internet
   address if the user is local.

 Revision 590.102  2002/02/07 04:42:49  ajc
 * Silently refuse to add directory entries for Internet addresses already
   belonging to other users.
 * cdb_trunc() for CtdlDirectoryInit: implemented for GDBM, stubbed for DB

 Revision 590.101  2002/02/05 05:05:53  ajc
 * Don't crash when posting if the user doesn't have an Internet directory address

 Revision 590.100  2002/02/03 15:29:03  error
 * fixed a silly oversight in serv_crypto.c when removing the ETLS command

 Revision 590.99  2002/02/03 15:21:48  error
 * Remove the ETLS command, it is no longer needed

 Revision 590.98  2002/02/02 21:44:04  ajc
 * If a user has at least one valid Internet directory address, stamp it onto
   any outgoing messages.

 Revision 590.97  2002/02/01 05:11:26  ajc
 * Added a QDIR protocol command to do quick-and-dirty queries of the directory
 * In the client, check the directory for conflicts when selecting email addr.

 Revision 590.96  2002/01/31 05:13:44  ajc
 * When deleting a vCard from the Global Address Book room, remove the
   corresponding address in the directory.  (Not tested.)

 Revision 590.95  2002/01/30 19:03:41  ajc
 * Added a new DeleteFunctionHook type of thing.  These get called when a
   message is being deleted from a room.
 * When deleting messages from a room, do the AdjRefCount() calls (and now,
   the PerformDeleteHooks() calls) in a second pass.  This keeps that stuff
   outside of the S_QUICKROOM critical section.

 Revision 590.94  2002/01/27 06:39:45  error
 * file_ops.c: fixed bug in cmd_read() which could cause server to report
   the wrong number of bytes for the client to download

 Revision 590.93  2002/01/26 21:33:38  ajc
 * More internet addressing and global directory stuff.  I think it's all working now
   except for the purging of old entries.

 Revision 590.92  2002/01/26 11:02:37  error
 * citadel.spec cleaned up

 Revision 590.91  2002/01/26 09:23:40  error
 * setup now has a silent running mode (-q option) where it silently sets
   defaults for everything.  This is intended for use in scripts such as
   the RPM packages, eliminating a step from the installation process.

 Revision 590.90  2002/01/26 09:19:16  error
 * citadel.spec has been completely overhauled, we can make RPMs now!

 Revision 590.89  2002/01/26 04:59:57  ajc
 * smtp FROM command now validates sender using the validate_recipients() loop
   (yeah, it's good for that too) making it directory-aware

 Revision 590.88  2002/01/26 04:01:10  error
 * Formatter now uses more of the available screen width

 Revision 590.87  2002/01/26 03:57:30  error
 * Revised status_line() display, it's much more compact now

 Revision 590.86  2002/01/26 03:50:26  error
 * Better error reporting in connection_died(), kills curses before printing
   error message, prints last errno.

 Revision 590.85  2002/01/25 05:19:03  ajc
 * Greatly simplified the logic for validating recipient addresses for incoming
   SMTP.  This logic destroys the whitespace mangling for local names; I will
   fix this tomorrow.

 Revision 590.84  2002/01/25 04:36:35  ajc
 * fixz to allow incoming vCards in the address book to actually get processed

 Revision 590.83  2002/01/24 06:52:54  error
 * citadel_decls.h: fix unresolved extern errors

 Revision 590.82  2002/01/23 05:04:05  ajc
 * Add vCards from incoming network messages in the GAB to the directory.

 Revision 590.81  2002/01/23 03:39:32  ajc
 * Added a new hook type for handling incoming network messages
 * Wrote a skeleton module for net filtering

 Revision 590.80  2002/01/22 10:46:25  error
 * read_message() and fmout() now accept a FILE to which to send their
   output; this fixes quoting in the fullscreen client

 Revision 590.79  2002/01/20 08:03:43  error
 * curses client: use the status line as "input" line in chat mode

 Revision 590.78  2002/01/20 07:43:07  error
 * serv_chat.c: Server no longer crashes when CHATLOG can't be opened

 Revision 590.77  2002/01/20 05:22:07  error
 * curses client:  allow goodbye message to be seen on some terminals

 Revision 590.76  2002/01/19 16:56:31  error
 * Fixed color support, now works when rc_ansi_color is on or auto

 Revision 590.75  2002/01/19 15:10:25  error
 * Cosmetics for the client status line

 Revision 590.74  2002/01/19 11:59:33  error
 * A real status line for the text client

 Revision 590.73  2002/01/19 10:08:43  error
 * fix link for libcitserver.so to tools.o which I broke (oops!)

 Revision 590.72  2002/01/19 09:59:08  error
 * Full-screen curses support for Citadel text client

 Revision 590.71  2002/01/17 20:11:05  nbryant
 remove lock.c/lock.h; don't need them for what i was planning after all

 Revision 590.70  2002/01/17 10:48:36  error
 * cosmetic fixes in the new trace file functionality

 Revision 590.69  2002/01/17 10:32:14  error
 * lprintf() now logs the session ID for each log entry within a session.
   Also SMTP, IMAP, POP3 and Citadel protocol commands are differentiated.

 Revision 590.68  2002/01/17 10:16:09  error
 * migratenet.c: cygwin fix: include limits.h

 Revision 590.67  2002/01/17 10:13:31  error
 * serv_ical.c: set expire policy for My Calendar> to manual

 Revision 590.66  2002/01/17 07:18:11  ajc
 * Changed all "free software" references to "open source" in order
   to piss off Richard Stallman

 Revision 590.65  2002/01/17 00:22:35  nbryant
 added lock.[ch]: recursive read/write locking support. (not actually used yet)

 Revision 590.64  2002/01/15 12:41:53  error
 * Implement alternate_semantics (see comments in citadel.rc file)

 Revision 590.63  2002/01/15 11:07:51  ajc
 * vcard.c: updated vCard "object methods" to handle multiple instances of
   the same key name when necessary.

 Revision 590.62  2002/01/15 06:38:39  error
 * Update citadelapi.txt with CtdlUnregister* calls, LogHook calls

 Revision 590.61  2002/01/15 06:20:18  error
 * Modules can now unregister any of their hooks (though none yet take
   advantage of this).

 Revision 590.60  2002/01/14 08:49:13  error
 * Fixed bug in cmd_cre8() causing protocol to get out of sync when creating
   a new room

 Revision 590.59  2002/01/13 04:46:31  ajc
 * Allow incoming SMTP to relay to other Citadel nodes for whom we are
   providing directory service.

 Revision 590.58  2002/01/13 04:06:33  ajc
 * Repaired the problems I created when moving the_mime_parser()'s variables
   from the stack to the heap.  (Hint: sizeof(char *) is 4, not 4096)

 Revision 590.57  2002/01/11 15:46:57  error
 * Allow users to move/copy messages between personal rooms

 Revision 590.56  2002/01/11 04:59:00  ajc
 * Finished most of the work for the Global Address Book.

 Revision 590.55  2002/01/11 04:37:03  ajc
 * More code for the Global Address Book

 Revision 590.54  2002/01/11 02:57:35  error
 * Don't print **** when sending a page or mail from an anonymous-only room

 Revision 590.53  2002/01/10 21:22:37  ajc
 * Minor changes for global directory service

 Revision 590.52  2002/01/10 04:29:28  ajc
 * Minor updates for directory service

 Revision 590.51  2002/01/09 23:12:40  ajc
 * Allow users to zap mailbox rooms

 Revision 590.50  2002/01/09 04:37:32  ajc
 * Finished the callback stuff for vCard address extraction

 Revision 590.49  2002/01/09 04:05:53  ajc
 * Began writing code to harvest Internet e-mail addresses from vCards, and
   hacked together a temporary version (and writeup) of the IGAB command.

 Revision 590.48  2002/01/08 16:34:22  ajc
 * serv_vcard.c: cosmetic cleanup

 Revision 590.47  2002/01/06 22:44:21  error
 * Enable/disable encryption in client from command line and/or citadel.rc

 Revision 590.46  2002/01/06 21:25:26  ajc
 * sysdep.c: in client_write(), handle redirect_fp and redirect_sock *before*
   handling redirect_ssl, because these need to be done the same way regardless
   of client session crypto
 * serv_crypto.c: pasted a bunch of Nathan's #ifdef blocks from sysdep.c in
   order to gain greater portability (or even to get it to compile on splorph)

 Revision 590.45  2002/01/06 11:13:33  error
 * Enable SSL/TLS support in the client (again)

 Revision 590.44  2002/01/06 11:11:31  error
 * Enable SSL/TLS in the client

 Revision 590.43  2002/01/06 10:49:55  error
 * Add some #includes I apparently somehow missed

 Revision 590.42  2002/01/06 10:33:10  error
 * SSL/TLS support for the Citadel/UX wire protocol

 Revision 590.41  2002/01/06 08:54:58  error
 * user_ops.c: fixed become_session() when calling EVT_LOGOUT session hooks

 Revision 590.40  2002/01/05 22:31:22  ajc
 * Removed some protocol commands and writeups that are no longer necessary
 * Began some of the framework for the Global Address Book

 Revision 590.39  2002/01/05 12:44:43  error
 * serv_chat.c: allow a session to be killed while in chat

 Revision 590.38  2002/01/05 12:31:04  error
 * user_ops.c: become_session() when calling EVT_LOGOUT session hooks

 Revision 590.37  2002/01/05 04:51:36  error
 * stats now sorts its top 20 lists properly

 Revision 590.36  2002/01/04 20:57:36  nbryant
 cygwin fix

 Revision 590.35  2002/01/04 20:46:26  nbryant
 Makefile fix for cygwin (fix migratenet linkage)

 Revision 590.34  2002/01/04 20:43:26  nbryant
 configure/genstamp: check for struct tm.tm_gmtoff

 Revision 590.33  2002/01/03 22:01:17  ajc
 * Fixed mail to "sysop"

 Revision 590.32  2002/01/03 21:35:07  ajc
 * I think this is the last of the fixes for the new submit queue.

 Revision 590.31  2002/01/03 12:27:35  error
 * Fixed my name in docs/copyright.txt, why didn't I notice that before?

 Revision 590.30  2002/01/03 12:21:02  error
 * Autoconf support for recognizing OpenSSL

 Revision 590.29  2002/01/03 04:52:28  ajc
 * serv_network.c: migrated deliveries and bounces to the new message
   submission subsystem.  NOT TESTED.

 Revision 590.28  2002/01/01 21:32:10  ajc
 * Finished the updates to serv_smtp.c, although I think there may be a
   problem with one-too-many reference counts when a message is submitted
   via SMTP.

 Revision 590.27  2001/12/31 20:15:13  ajc
 * Almost finished converting serv_smtp.c to the new message submission
   framework.  Still not done yet; don't use this.

 Revision 590.26  2001/12/30 06:20:46  error
 * More keys while reading messages:  Q or S same as Ctrl-C, N same as Ctrl-O.

 Revision 590.25  2001/12/30 05:50:46  error
 * Security:  Citadel now drops privileges when called from telnetd, also
   checks to make sure you didn't set the setuid/setgid bits.  No more
   loginwrapper.sh!

 Revision 590.24  2001/12/29 05:19:32  ajc
 * Minor cosmetic hack

 Revision 590.23  2001/12/29 04:21:22  nixo
 stupid me. I didn't realize that asking for the header did what I wanted
 so I changed my little 'y' hack to not bother reading the text of the
 message. a little saving on the bandwidth.

 Revision 590.22  2001/12/28 22:32:38  nixo
 Added a "read m<y> next" function in read mode. It will skip to the next
 message by the user in the current message list (whatever mode you're in
 be it read forward, last 50, whatever.)

 Revision 590.21  2001/12/28 11:06:53  error
 * More server support for hostnames up to 63 characters (oops I missed a spot)

 Revision 590.20  2001/12/28 09:39:10  error
 * Client support for hostnames up to 63 characters: truncated at 24 in
   short who list, full display in long who list.

 Revision 590.19  2001/12/28 09:28:04  error
 * Server support for hostnames up to 63 characters

 Revision 590.18  2001/12/26 05:01:30  ajc
 * Added a new developer ID for Anticlimactic Teleservices

 Revision 590.17  2001/12/23 10:00:43  error
 * Pages are once again formatted to the caller's screen width.

 Revision 590.16  2001/12/23 09:57:47  error
 * tools.c: added parameter to fmt_date() to allow for printing the seconds
   along with the time, e.g. 12:34 pm or 12:34:56 pm

 Revision 590.15  2001/12/20 04:54:26  ajc
 * If you paid for this software, someone is ripping you off.

 Revision 590.14  2001/12/18 08:24:56  nbryant
 more lovely configure tweaks (include paths for db)

 Revision 590.13  2001/12/18 06:04:08  ajc
 * Moved the buffers in the_mime_parser() from the stack to the heap, because
   it was crashing boxen with small stack sizes.

 Revision 590.12  2001/12/18 05:54:16  ajc
 * Added more load_floorlist() commands to the beginning and end of functions
   in the client that manipulate the floor list.  This fixes a bug in which
   new floors don't show up right away after being created.

 Revision 590.11  2001/12/17 08:14:26  nbryant
 restored the checks for /usr/include/db3 and /usr/local/include/db3
 in configure.  there are too many variations on db installation; this is
 getting messy :-(

 Revision 590.10  2001/12/17 08:00:45  nbryant
 set the pthreads stack size to 128K because FreeBSD's default of 64K
 seems too small. fixes crashes under FreeBSD.

 Revision 590.9  2001/12/16 00:50:14  error
 * Added usersupp.lastcall to the parameters returned from the PASS/PAS2
   commands in logged_in_response().

 Revision 590.8  2001/12/14 21:33:18  nbryant
 finally changed configure to complain if there's no database driver ;)

 Revision 590.7  2001/12/14 08:29:30  error
 * Security: trace file is now only readable by owner, since it contains
   plain text passwords.

 Revision 590.6  2001/12/14 07:04:24  ajc
 * Now you can send mail to yourself.  Hi from Stu.

 Revision 590.5  2001/12/14 06:58:12  ajc
 * Hi from Stu

 Revision 590.4  2001/12/13 22:36:30  nbryant
 make configure search for /usr/local/BerkeleyDB.4.0

 Revision 590.3  2001/12/13 22:29:57  nbryant
 make it compile with Berkeley DB 4.0.x

 Revision 590.2  2001/12/11 21:31:07  nbryant
  - test for -ldb3 before -ldb

 Revision 590.1  2001/12/11 20:04:41  nbryant
  - fix library flags, includes for portability
  - malloc.h is deprecated
  - fix genstamp, hopefully
  - fix size_t *printf handling for portability

 Revision 590.0  2001/12/08 03:31:41  ajc
 * THIS IS 5.90

 Revision 580.95  2001/12/08 03:30:37  ajc
 * Final changes to networking docs for 5.90

 Revision 580.94  2001/12/06 05:13:34  ajc
 * Added the documentation for room sharing and listserv

 Revision 580.93  2001/12/04 05:24:15  ajc
 * Added two more bytes to the possible length of shared secrets in networking
   due to some legacy support requirements.

 Revision 580.92  2001/12/04 05:16:19  ajc
 * mime_parser.c: change to memory allocation algorithm ... some badly done
   messages were crashing the server

 Revision 580.91  2001/12/03 22:48:16  ajc
 * ooops.  Look for the QR2_SYSTEM flag in QRflags2, not QRflags.

 Revision 580.90  2001/12/03 17:02:50  ajc
 * dynloader.c: fixed improperly done declaration and mallok()

 Revision 580.89  2001/12/03 04:28:02  ajc
 * mime_parser.c: now uses built-in functions to decode base64 and
   quoted-printable attachments, instead of piping data to outboard programs.

 Revision 580.88  2001/12/03 02:45:46  ajc
 * Began implementing some code to handle multiple recipients (but #define'd
   it all out because we're approaching a release)

 Revision 580.87  2001/12/03 01:50:17  ajc
 * When sending mail, copy to the sender's "Sent Items>" room instead of to
   the sender's "Mail>" room.

 Revision 580.86  2001/12/02 23:36:24  ajc
 * On a new system, set the default new user level to 4 instead of 1.

 Revision 580.85  2001/12/02 23:27:01  ajc
 * Removed references to the old networker from the documentation.  Did not
   write any new documentation, so what's there now is kind of sparse.

 Revision 580.84  2001/12/02 02:42:55  ajc
 * Implemented new room flag QR2_SYSTEM which supresses the room from all
   room listings, even for Aides (but it's still gotoable).  This will be used
   for rooms which hold system configuration and message queues.

 Revision 580.83  2001/12/01 19:23:26  ajc
 * clientsocket.c: implement socket timeouts for read operations

 Revision 580.82  2001/12/01 17:00:23  ajc
 * serv_smtp.c: when multiple MX's are the same preference, randomize them

 Revision 580.81  2001/12/01 07:18:28  ajc
 * Fixed an SMTP delivery problem that was causing certain classes of
   transient errors to cause a message to never be delivered.

 Revision 580.80  2001/12/01 05:26:01  ajc
 * Added a command "SMTP" to the Citadel protocol, to do some unimportant
   utility/diagnostic functions.

 Revision 580.79  2001/11/27 17:08:29  ajc
 * When calling an external editor, set the environment variable
   WINDOW_TITLE to an appropriate value.

 Revision 580.78  2001/11/26 03:27:08  ajc
 * new algorithm to load the use table

 Revision 580.77  2001/11/17 19:55:08  ajc
 * Updated some of the documentation

 Revision 580.76  2001/11/16 04:43:12  ajc
 * Eliminated the sock_puts_crlf() function and ensured that all SMTP client
   commands are sent out using a single sock_write() call.  There are broken
   SMTP server implementations that can't handle SMTP commands split across
   multiple writes.  (Thanks to Andru Luvisi and Ben Mehlman for the idea.)

 Revision 580.75  2001/11/15 04:11:30  ajc
 * hack.doc: updated to reflect Cit86Net compatibility fields removed from the
   file format (since we dumbed down the gateway software)
 * ipc_c_tcp.c: removed SOCKS4 support.  Nobody uses it anymore.
 * ipc_c_tcp.c: fixed a bug which caused the client to fall back to defaultPort
   if a numeric port number was specified instead of a service name

 Revision 580.74  2001/11/14 02:59:01  ajc
 * Network run frequency is now a site-definable setting

 Revision 580.73  2001/11/13 22:05:23  ajc
 * Re-introduced the ability to enter IGnet mail into the system.

 Revision 580.72  2001/10/29 22:59:22  ajc
 * Renamed "SuppMsgInfo" to "MetaData" because that's what it is

 Revision 580.71  2001/10/29 16:39:54  ajc
 * Finished the migratenet utility (finally).

 Revision 580.70  2001/10/28 05:18:51  ajc
 * migratenet almost finished

 Revision 580.69  2001/10/26 04:26:45  ajc
 * more work on the net migrator

 Revision 580.68  2001/10/23 03:37:33  ajc
 * Threw a few more lines of code into migratenet.c

 Revision 580.67  2001/10/20 18:10:50  ajc
 * migratenet.c: added (not even close to being finished)

 Revision 580.66  2001/10/17 21:07:20  nbryant
 further format string cleanups (for i686-linux type sizes)

 Revision 580.65  2001/10/17 20:41:07  nbryant
  - declare *printf format specifiers if gcc detected
  - format string fixes (compiles w/o warnings on alpha osf/1)

 Revision 580.64  2001/10/17 19:40:38  nbryant
 warning fixes and cleanups for 64-bit machines

 Revision 580.63  2001/10/16 20:47:37  nbryant
 - backed out -export-dynamic, it doesn't do anything and i've found the real
 problem
 - remove declaration for make_message

 Revision 580.62  2001/10/16 19:18:49  nbryant
 backed out that compiler detection change for Tru64. it's not incredibly
 important and results in broken autoconf macro expansions.

 Revision 580.61  2001/10/16 18:36:33  nbryant
 reinstate -export-dynamic for citserver in case libtool decides to build
 static libraries (why?)

 Revision 580.60  2001/10/16 18:21:53  nbryant
 add some explanatory text to bootstrap

 Revision 580.59  2001/10/16 17:43:53  nbryant
  - further configure tweaks for FreeBSD and Tru64 Unix
  - updated to latest libtool configure fragment
  - there are two functions named make_message. (?) so declare them both
    static.

 Revision 580.58  2001/10/16 01:48:55  nbryant
 - configury tweaks for a /usr/include/db3 goof and Digital/Tru64 Unix
 - #ifdef out inline on non-GCC compilers

 Revision 580.57  2001/10/15 19:50:50  ajc
 * Fixed a bug in the loopzapper that was corrupting the use table saved copy.
 * Post notification in Aide> when the loopzapper catches a message.

 Revision 580.56  2001/10/12 22:41:11  ajc
 * Wrote the rest of the use table code.  Finished except for a bug.

 Revision 580.55  2001/10/10 18:35:12  ajc
 * Comments & cosmetics for previous update

 Revision 580.54  2001/10/10 17:12:54  ajc
 * Bugfix for MSG0 command to properly handle multipart/alternative

 Revision 580.53  2001/10/06 21:32:29  ajc
 * Finished the concurrency check for network polling.  (Now works both for
   polling and being polled.  Severe UUCP deja vu.)

 Revision 580.52  2001/10/06 20:28:06  ajc
 * Began implementing some concurrency stuff for the networker

 Revision 580.51  2001/10/06 19:51:47  ajc
 * Stripped the build of obsolete parts of the old networker no longer in use.

 Revision 580.50  2001/10/03 20:05:50  ajc
 * serv_smtp.c: implement RFC2920 ESMTP "pipelining" extension on the server
   side.  (No changes required other than advertising the extension.)

 Revision 580.49  2001/10/03 03:15:16  ajc
 * Implemented BOUNCE BOUNCE BOUNCE

 Revision 580.48  2001/10/02 03:04:30  ajc
 * Allow non-Aides to terminate sessions belonging to them

 Revision 580.47  2001/09/24 18:55:13  ajc
 * Completed migrating the "netpoll" utility into the serv_network module.
   Removed this utility.

 Revision 580.46  2001/09/21 20:58:25  nbryant
 support different log_archive prototype in DB versions prior to 3.3

 Revision 580.45  2001/09/20 04:17:10  ajc
 * Inbound network authentication working.  Fixed a bug in the split-horizon
   algorithm.  Still need to move the 'netpoll' command into the server.

 Revision 580.44  2001/09/18 04:05:04  ajc
 * Added host/IP and port to node config (client side only)

 Revision 580.43  2001/09/17 23:55:45  ajc
 * Support for IGnet routing (not tested)

 Revision 580.42  2001/09/16 05:44:51  ajc
 * serv_smtp.c: instead of doubling delivery retry times unbounded, set a
   maximum retry time of SMTP_RETRY_MAX (currently set to 12 hours)

 Revision 580.41  2001/09/09 16:19:29  error
 * Updated PAM configuration file citadel.pam for Red Hat 7.x.

 Revision 580.40  2001/09/09 03:19:38  ajc
 * cdb_cull_logs() now removes log files as soon as the log_archive() function
   says it's ok to do so.

 Revision 580.39  2001/09/08 18:58:38  ajc
 * More changes to the new networker.  Added client command for room sharing.

 Revision 580.38  2001/09/07 04:05:27  ajc
 * You guessed it: still more code for the new networker.

 Revision 580.37  2001/09/06 05:47:29  nbryant
 check for /usr/include/db3 (for RedHat 6.2; others?)

 Revision 580.36  2001/09/06 05:23:14  nbryant
 #include fix for glibc 2.1.3

 Revision 580.35  2001/09/06 04:02:34  ajc
 * A few more updates to the networker

 Revision 580.34  2001/09/06 03:32:41  nbryant
 build fix for sparc-sun-solaris2.8; i think the dependencies should be
 set up properly for all platforms now.

 Revision 580.33  2001/09/06 02:55:27  nbryant
 build fix for Linux

 Revision 580.32  2001/09/06 02:49:22  ajc
 * Fixed paste-post mode (<.E>nter <A>scii) to append instead of replace when
   the user hits <C>ontinue (bug reported by Stu Mark)

 Revision 580.31  2001/09/06 01:26:39  nbryant
  - port to Cygwin (DLL support, etc.)
  - don't build SMTP module if there's no resolver library (eg on Windows)

 Revision 580.30  2001/09/06 00:54:01  nbryant
 updated to libtool 1.4.1 and automake 1.5

 Revision 580.29  2001/08/29 02:51:25  ajc
 * More work on the new networker.

 Revision 580.28  2001/08/25 05:04:57  ajc
 * Worked a little more on the in-server replacement for netproc

 Revision 580.27  2001/08/22 04:18:17  ajc
 * Realized that there was lots of similarly broken code in
   process_rfc822_addr().  Wrote two new utility functions in tools.c
   stripout() and stripallbut() and used them where appropriate.  This should
   take care of all possible infinite loops.

 Revision 580.26  2001/08/22 03:43:11  ajc
 * internet_addressing.c: fixed a bug in process_rfc822_addr() that caused the
   server to jump into an endless loop when an e-mail address contained
   unbalanced angle brackets.

 Revision 580.25  2001/08/15 04:26:02  ajc
 * Added split horizon and delete-after-spool to the new networker

 Revision 580.24  2001/08/14 02:41:57  ajc
 * Began the migration of netproc into part of the serv_network.c module instead
   of a standalone program.

 Revision 580.23  2001/08/11 22:35:40  nbryant
 updated citadel-with-berkeley-db.txt.
  - updated build instructions
  - improved backup procedures to be safer and more space-efficient.

 Revision 580.22  2001/08/11 19:18:41  ajc
 * Realized that I am stupid and started implementing server commands to load
   and save network configurations, when I had already lovingly implemented the
   CONF GETSYS and CONF PUTSYS commands to store arbitrary configuration sets
   in the Local System Configuration> room.  Ripped the newer crap out.
 * Implemented a skeleton of <.A>ide <S>ysconfig <N>etwork on the client side.

 Revision 580.21  2001/08/11 03:51:56  ajc
 * Removed the idle timer from the client.  Dialup is dead.

 Revision 580.20  2001/08/06 21:33:29  nbryant
 made the client fall back on port 504 if there's no /etc/services entry

 Revision 580.19  2001/08/05 23:54:14  ajc
 * prep for new network node infrastructure

 Revision 580.18  2001/08/03 16:53:21  ajc
 * Added some more "break" statements to the main switch..case loop in
   citadel.c where they were needed.

 Revision 580.17  2001/08/03 16:43:53  ajc
 * database_sleepycat.c: when running txn_checkpoint(), handle DB_INCOMPLETE
   return code as a warning instead of an error worthy of aborting the server.
   See http://www.sleepycat.com/docs/api_c/txn_checkpoint.html for explanation.

 Revision 580.16  2001/07/30 03:46:14  nbryant
 made ForEachUser use a read-only cursor, too. there is now only one piece of
 code in Citadel proper (not the database driver) that needs transactions.
 that's check_ref_counts; in other words it's the only thing standing in the way
 of a clean implementation of retryable transactions.

 Revision 580.15  2001/07/29 22:24:04  nbryant
  - added a new function to the database interface, cdb_close_cursor().  always
 call this when you're finished with a traversal but didn't bother reading all
 the way to the end.

  - removed several cdb_begin_transaction()/cdb_end_transaction() calls that are
 no longer needed because of the read-only cursor support.

 Revision 580.14  2001/07/29 20:56:09  nbryant
 change ForEachRoom to use read-only cursors by default. it can be overridden to
 still use read/write cursors by doing:

  cdb_begin_transaction();
  ForEachRoom(...);
  cdb_end_transaction();

 the only place I found where it appears necessary to do so is check_ref_counts,
 so this checkin affects that function too.

 Revision 580.13  2001/07/29 20:06:33  nbryant
 generate symlinks to .libs in modules directory

 Revision 580.12  2001/07/28 00:02:50  nbryant
 implemented read-only cursors. one of the advantages to these is that
 transactions can be avoided; a cursor operation that occurs within a
 transaction will often acquire a read lock on every single database page.  in
 general, the Sleepycat documentation recommends avoiding transaction-protected
 read-only operations where practical. read/modify/write operations can still
 be transaction protected, of course.

 to use a read-only cursor, call cdb_rewind without a previous call to
 cdb_begin_transaction. the DB driver will notice this and prevent the current
 thread from modifying data or starting a transaction until the cursor is
 closed.

 Revision 580.11  2001/07/27 20:45:44  nbryant
 libtool has matured a lot since the last time i looked at it (years ago)
 so we now use it to handle the details of building shared libraries and
 the linker flags for the main executable.

 in theory this should bring a lot more portability to the dynloader
 subsystem and enable us to do things like transparently detect GNU vs Sun
 linkers on solaris, for example

 Revision 580.10  2001/07/27 03:29:04  nbryant
 missed one thing in the autoconf move

 Revision 580.9  2001/07/27 02:57:43  nbryant
 support one cursor per database rather than one global cursor

 Revision 580.8  2001/07/27 01:32:07  nbryant
 remove the automatic transaction demarcation on singleton read operations

 Revision 580.7  2001/07/26 21:43:46  nbryant
  - move to autoconf 2.52
  - random warning fix
  - check for db 3.3

 Revision 580.6  2001/07/24 13:17:54  ajc
 * New UI for mailing list setup
 * rooms.c: code cleanup
 * docs update

 Revision 580.5  2001/07/20 23:48:23  nbryant
 fix build on solaris, check default install location for db 3.2, and silence
 gcc 3.0

 Revision 580.4  2001/07/16 14:24:30  ajc
 * Silly cosmetic change to keep the wholist ordered by ascending session number

 Revision 580.3  2001/07/13 00:01:36  ajc
 * Shuffled around some of the housekeeping loop code

 Revision 580.2  2001/07/11 17:01:10  ajc
 * database_sleepycat.c: small changes to log messages

 Revision 580.1  2001/07/11 04:35:40  nbryant
 moved dret initialization in cdb_fetch, just in case

 Revision 580.0  2001/07/03 03:07:06  ajc
 * THIS IS 5.80

 Revision 573.143  2001/07/03 03:06:50  ajc
 * Last minute doco update for 5.80

 Revision 573.142  2001/07/01 15:44:32  nbryant
 configure.in: check for Berkeley DB first.

 Revision 573.141  2001/06/27 23:34:30  ajc
 * Added some verbage to messages/roomaccess to placate a user who keeps
   bitching about privacy policy.

 Revision 573.140  2001/06/19 03:41:04  ajc
 * Ooops... last_cull needs to be declared static

 Revision 573.139  2001/06/19 03:33:19  ajc
 * imap_fetch.c: download MIME parts without decoding first.  We like that.
 * database_sleepycat.c: added automatic culling of log files which have not
   been written to in five days.

 Revision 573.138  2001/06/17 19:42:23  nbryant
 fix all the <time.h> vs. <sys/time.h> issues, hopefully

 Revision 573.137  2001/06/07 03:28:37  ajc
 * More tweaks to the MIME parser

 Revision 573.136  2001/06/06 15:44:37  ajc
 * msgbase.c: output extra newline at end of RFC822 message if necessary to
   ensure that 000 termination string appears on a line by itself.

 Revision 573.135  2001/06/06 04:22:25  ajc
 * Moved memreadline() to tools.c
 * internet_addressing.c: fixed conversion of fields to (hopefully) never get
   into an active loop when encountering badly formed headers

 Revision 573.134  2001/05/27 05:23:03  ajc
 * Added a "no new messages" response in the client, displayed when a read
   command turns up a zero message count.

 Revision 573.133  2001/05/18 20:12:09  ajc
 * Fixed bug in mime_parser.c that caused parts to be dropped when the last
   boundary was the very last line of the message.
 * serv_smtp.c: toned down some of the command response verbage.

 Revision 573.132  2001/04/28 04:42:55  ajc
 * Updated some of the docs.  Bumped version number to 5.80 in anticipation
   of going into a release cycle soon.

 Revision 573.130  2001/04/26 03:31:00  ajc
 * Finished the implementation of per-message seen/unseen logic, both in the
   server proper and in IMAP.  Citadel protocol uses new "seen" command.

 Revision 573.129  2001/04/21 04:55:51  ajc
 * Began implementation of per-message seen/unseen attribute

 Revision 573.128  2001/04/20 03:39:54  ajc
 * IMAP LIST/LSUB: made it case insensitive.  Also minor IMAP code cleanup.

 Revision 573.127  2001/04/17 00:35:19  cough
 * Modified rooms.c in the client so that it would allow inviting into
   public rooms.  This is important since there is now a V_LOCKOUT
   flag which prevents users who have been kicked from rejoining
   a room unless/until you invite them back in.

 Revision 573.126  2001/04/16 19:21:14  cough
 * Fixed bug in room_ops.c that wasn't allowing aides to goto passworded
   rooms without knowing the password.

 Revision 573.125  2001/04/14 04:26:44  ajc
 * Fixed an unterminated string bug in IMAP APPEND.  Storing messages should
   work now.

 Revision 573.124  2001/04/10 01:04:10  ajc
 * Finished coding IMAP APPEND.  It works, but there's a bug in it somewhere
   that is corrupting the memory.

 Revision 573.123  2001/04/03 00:47:23  ajc
 * Began implementing IMAP APPEND

 Revision 573.122  2001/04/01 22:05:44  cough
 * *Actually* fixed a botched ChangeLog entry.

 Revision 573.121  2001/04/01 22:04:28  cough
 * Fixed a botched ChangeLog entry.

 Revision 573.120  2001/04/01 22:03:10  cough
 * Changed two fclose()s to pclose()s.

 Revision 573.119  2001/03/25 11:52:36  error
 * serv_pop3.c: Fixed APOP. Now logs in properly. Also cleaned up some non-
   RFC-compliant error messages.

 Revision 573.118  2001/03/21 05:47:49  ajc
 * Added the new IMAP mailbox string compare submitted by Daniel Malament.

 Revision 573.117  2001/03/20 01:33:55  ajc
 * Added the (\NoInferiors) tag to all rooms listed in IMAP.  This made Mozilla
   behave very nicely.

 Revision 573.116  2001/03/13 17:19:33  ajc
 * support (BODY[HEADER.FIELDS(BLAH BLAH BLAH)]) and HEADER.FIELDS.NOT

 Revision 573.115  2001/03/12 01:27:42  ajc
 * Implemented SUBSCRIBE and UNSUBSCRIBE commands

 Revision 573.114  2001/03/11 23:00:29  ajc
 * Mega sexy hack to deliver express messages THROUGH IMAP!  uber coolness!!

 Revision 573.113  2001/03/11 22:09:20  ajc
 * Replaced the "citlogin" binary wrapper with the "loginwrapper.sh" script.

 Revision 573.112  2001/03/11 20:06:53  ajc
 * Fixed bug that created incorrect roomnames when sending pages

 Revision 573.111  2001/03/11 19:23:32  ajc
 * IMAP DELETE command ... also split up access control for room delete cmds

 Revision 573.110  2001/03/10 17:29:07  ajc
 * Implement proper access control for deleting messages from IMAP

 Revision 573.109  2001/03/07 04:02:27  ajc
 * Fixed some small IMAP bugs

 Revision 573.108  2001/03/06 04:44:00  ajc
 * Probable completion of STATUS, COPY, STORE, and EXPUNGE commands in IMAP

 Revision 573.107  2001/03/06 03:31:58  nbryant
 database-related cleanups and paranoia tests;
 fixed a transaction-leak/deadlock problem in cdb_delete;
 solved the SIGPIPE mystery (GDB stops on SIGPIPE is all it was)

 Revision 573.106  2001/03/05 04:59:31  ajc
 * IMAP COPY

 Revision 573.105  2001/03/04 23:49:41  ajc
 * IMAP EXPUNGE responses -should- be correct now

 Revision 573.94  2001/02/20 00:02:56  ajc
 * IMAP: implemented the STATUS command (sort of).

 Revision 573.93  2001/02/19 22:24:41  ajc
 * IMAP server: added untagged, unsolicited server messages for newly arrived
   messages, and messages expunged by another session.

 Revision 573.92  2001/02/17 05:53:35  ajc
 * Repaired the creation of page log rooms in the wrong namespace when the
   recipient does not yet have his/her log room created.
 * Rewrite "EXPI messages" to run in two passes: one to gather messages to
   purge and the next to delete them.  Works better in transactionland.

 Revision 573.91  2001/02/14 08:11:27  error
 * citadel.rc: added $Id$ (it's about time!)

 Revision 573.90  2001/02/14 04:23:54  ajc
 * Fixed POP3 server responses ending in \n instead of \r\n as they should be.
   This was causing some clients (such as Pine) to lock up.

 Revision 573.89  2001/02/13 04:06:14  ajc
 * Worked out the remaining bugs in IMAP FETCH for the BODYSTRUCTURE and
   BODY[n] data items.  I think.  So much protocol crud, so little time...

 Revision 573.88  2001/02/13 01:18:44  ajc
 * imap fetch

 Revision 573.87  2001/02/12 04:31:34  ajc
 * sysdep.c ig_tcp_server() - use IPPROTO_TCP instead of getprotobyname()

 Revision 573.86  2001/02/08 04:45:58  ajc
 * Fixed namespace problems resulting from the automatic namespece prefixing
   added to create_room().  Also added the ability to specify "create a mailbox
   but I've already supplied the namespace prefix" for situations where the
   namespace isn't that of the logged in user.
 * Made the POP3 server response messages slightly less humorous

 Revision 573.85  2001/02/06 04:44:12  ajc
 * Added a floor listing (complete with \NoSelect flag) to LIST and LSUB

 Revision 573.84  2001/02/06 02:09:38  ajc
 * citadel.rc: changed the default for local_screen_dimensions to 1, since
   Internet users now outnumber dialup users 100 to 0.
 * room_ops.c: added a really_create option to create_room().  Also moved the
   generation of personal namespace into that function.  MODULE OWNERS PLEASE
   CHECK YOUR CALLS TO AVOID MULTIPLE NAMESPACING!!
 * room_ops.c: fixed a bug in cgetfloor() that left bad pointers around
 * serv_imap.c: finished the CREATE command (finally)

 Revision 573.83  2001/02/05 05:20:22  ajc
 * Made some changes to functions which translate between Citadel room names
   and IMAP folder names.  They're still buggy.

 Revision 573.82  2001/02/04 23:17:28  ajc
 * Implemented the IMAP CREATE command

 Revision 573.81  2001/02/04 02:40:07  ajc
 * more imap.  imap sucks.  die crispin die.

 Revision 573.80  2001/02/03 10:02:12  error
 * serv_ical.c: Verify that objects posted to My Calendar> are of type
   text/x-calendar or text/calendar; abort saving if not

 Revision 573.79  2001/02/03 09:30:46  error
 * serv_ical.c: now creates a My Calendar> personal room, sets attributes

 Revision 573.78  2001/02/03 08:21:00  error
 * serv_ical.c and serv_ical.h added; skeleton code for now

 Revision 573.77  2001/02/02 20:18:18  ajc
 * Changed the error message in cdb_delete() to actually *say* cdb_delete
   instead of cdb_store.  Useful to know which function failed...

 Revision 573.76  2001/02/01 04:08:03  ajc
 * IMAP minor change to mailbox name output
 * Increased size of buffer in lprintf()

 Revision 573.75  2001/01/28 09:50:02  error
 * sysdep.c: lprintf() now generates timestamps

 Revision 573.74  2001/01/28 07:35:04  error
  * serv_bio.c: RBIO now also returns stats about a user, see session.txt

 Revision 573.73  2001/01/16 04:03:13  ajc
 * yeesh ... more on the IMAP BODYSTRUCTURE

 Revision 573.72  2001/01/16 01:51:12  ajc
 * imap bodystructure

 Revision 573.71  2001/01/16 00:46:40  ajc
 * Changed the MIME parser API *again* because we now need the ability to
   supply callback functions to be executed before and/or after parsing a
   multipart.  (Need this for IMAP BODYSTRUCTURE output.  Crispin sucks.)

 Revision 573.70  2001/01/15 23:59:26  ajc
 * user_ops.c: reject NULL password in CtdlTryPassword() instead of crashing

 Revision 573.68  2001/01/15 20:34:04  ajc
 * "Path:" removed for now because it confuses brain-dead Microsoft shitware
   into thinking that mail messages are newsgroup messages instead.  When we
   add NNTP support back into Citadel we'll have to add code to only output
   this field when appropriate.

 Revision 573.67  2001/01/15 16:30:31  ajc
 * temporary implementation of 901 asynchronous express messages

 Revision 573.66  2001/01/14 14:55:39  ajc
 * Changed the format of <.W>holist <L>ong

 Revision 573.65  2001/01/13 06:40:26  nbryant
 merged remaining changes from TRANSACTIONS (using cvs update -j TRANSACTIONS)
 which should now be considered closed.

 Revision 573.64  2001/01/13 06:12:15  ajc
 * Added the ASYN command

 Revision 573.63  2001/01/12 22:05:46  ajc
 * Fixed a bug that caused bogus wholist lines to be displayed when a non-aide
   reads a list containing stealth mode sessions.

 Revision 573.62  2001/01/09 05:39:45  ajc
 * Merged in code from the TRANSACTIONS branch for testing.

 Revision 573.61  2000/12/30 06:17:17  ajc
 * Still more work on IMAP.  Damn this is tedious.

 Revision 573.60  2000/12/30 04:55:05  ajc
 * more buffer size stuff

 Revision 573.59  2000/12/27 20:19:51  ajc
 * The size constant "256" which shows up everywhere as a buffer size has now
   been changed to SIZ.  And, SIZ has been defined now as 1024, not 256, because
   we need 1024 byte buffers for most Internet protocols.

 Revision 573.58  2000/12/27 05:09:58  ajc
 * Added a skeleton IMAP "SEARCH" command (based on the FETCH logic)

 Revision 573.57  2000/12/26 03:46:50  ajc
 * More IMAP tweaks

 Revision 573.56  2000/12/25 22:50:43  ajc
 * Added an API function to extract and unfold specific RFC822 fields.
 * imap-->fetch-->envelope-->in-reply-to now works
 * More robust checking and reporting of temp file errors in the client

 Revision 573.55  2000/12/25 20:43:24  ajc
 * imap_fetch.c: added support for fetch-->envelope-->from

 Revision 573.54  2000/12/20 04:09:24  ajc
 * A few memory handling fixes to netproc.

 Revision 573.53  2000/12/20 01:57:37  ajc
 * netproc.c: added bounds check to fpgetfield()

 Revision 573.52  2000/12/19 20:41:55  ajc
 * Fixed generation of unique file names for network uploads etc.

 Revision 573.51.2.11  2000/12/26 05:30:55  nbryant
 remove extraneous transaction around dynamic module initializations. this will
 fix the crash on database creation.

 Revision 573.51.2.10  2000/12/24 23:00:58  nbryant
 clean: also remove parsedate.c

 Revision 573.51.2.9  2000/12/20 01:38:42  nbryant
 require transactional cursors

 Revision 573.51.2.8  2000/12/20 00:30:01  nbryant
 release any stale db handles at the end of a server command
 (unfinished transactions will be aborted to annoy lazy programmers)

 Revision 573.51.2.7  2000/12/19 06:18:27  nbryant
 set sched_yield as sleepycat's yield function. this should improve locking
 performance.

 Revision 573.51.2.6  2000/12/19 02:22:29  nbryant
 added automatic transaction start/end on cdb_fetch, cdb_delete, and cdb_store

 Revision 573.51.2.5  2000/12/18 03:51:13  nbryant
 ditto S_USER_TRANS, S_CALLLOG, and S_HOUSEKEEPING, which are no longer used at
 all

 Revision 573.51.2.4  2000/12/18 02:49:17  nbryant
 removed all references to S_MSGMAIN critical section; it wasn't really needed.
 this should make things significantly more scaleable.

 Revision 573.51.2.3  2000/12/17 22:12:48  nbryant
 reworked shutdown sequence to wait for worker threads to terminate before
 checkpointing and closing databases. it is no longer safe to call
 master_cleanup() directly to force a shutdown; instead, just set
 time_to_die to a nonzero value

 Revision 573.51.2.2  2000/12/17 05:06:09  nbryant
 added deadlock detection and cleaned up messages

 Revision 573.51.2.1  2000/12/16 21:06:59  nbryant
 created TRANSACTIONS branch
 track cursor and transaction id's in thread-specific data

 Revision 573.51  2000/12/14 18:36:34  ajc
 * Fixed the "users not in chat" wholist display

 Revision 573.50  2000/12/12 18:06:46  ajc
 * Removed the transaction stuff (but left the log in).  It wasn't working.

 Revision 573.49  2000/12/12 06:19:55  ajc
 * Stabilize, dammit!!

 Revision 573.48  2000/12/12 04:20:03  ajc
 * Made the transaction open/close a global thing, in a frantic attempt to get
   Uncensored to stop crashing.  More fixes on the way...

 Revision 573.47  2000/12/11 06:08:41  ajc
 * Removed the housekeeper thread, moved terminate_idle_sessions() out to a
   timer event, and check_sched_shutdown() to the end of the worker thread
   loop.  Seems to have improved reliability (but why?)

 Revision 573.46  2000/12/11 03:22:11  ajc
 * Added server-side REQT command to issue client termination requests

 Revision 573.45  2000/12/11 02:19:26  ajc
 * Client now honors EM_GO_AWAY flag, used by the server to request that a
   client log off.  (The server doesn't support sending that flag yet, though)

 Revision 573.44  2000/12/09 06:20:06  ajc
 * A few final touches to the Sleepycat DB back-end

 Revision 573.43  2000/12/08 17:06:33  ajc
 * Wrap txn_begin and txn_end in S_DATABASE mutex

 Revision 573.42  2000/12/07 20:21:39  ajc
 * begin/end transaction in master_startup()

 Revision 573.41  2000/12/07 16:59:02  nbryant
 added --with-db and --with-gdbm options to configure

 Revision 573.40  2000/12/07 04:50:33  ajc
 * Wrap housekeeper and timer events in transaction open/close functions
 * Checkpoint the DB as an EVT_TIMER event instead of after each session
   (runs each minute, but actually limited by the parameters of the function)

 Revision 573.39  2000/12/06 04:44:36  ajc
 * Changed netproc to keep the use table in a flat file instead of a database

 Revision 573.38  2000/12/05 05:32:58  ajc
 * Added support for non-USA country identities in vCard and registration
 * User edit now asks whether it should prompt to change the password

 Revision 573.37  2000/12/03 04:12:21  ajc
 * Finished (mostly) the Sleepycat DB backend ... added transaction logging

 Revision 573.36  2000/11/30 03:23:17  ajc
 * Got the Sleepycat DB back end working, by opening the databases in a non
   shared, non threaded mode, and using Citadel's locking to serialize access.

 Revision 573.35  2000/11/29 05:00:02  ajc
 * I think the db stuff is ok, but my db library is fux0red...

 Revision 573.34  2000/11/27 14:12:09  error
 * commands.c: fixups to print_express() to make external command not print
   extraneous stuff to the terminal and make the displayed message consistent

 Revision 573.33  2000/11/27 10:41:14  error
 * print_express(): now uses GEXP instead of old PEXP; displays timestamps

 Revision 573.32  2000/11/27 10:29:59  error
 * serv_chat.c: fix send_express_message() to include timestamps

 Revision 573.31  2000/11/27 03:44:27  ajc
 * Initial checkin of database_sleepycat.c (doesn't work yet)

 Revision 573.30  2000/11/26 05:24:22  ajc
 * msgbase.c: Added new API function CtdlOutputPreLoadedMsg(), and
   re-implemented the existing CtdlOutputMsg() as a wrapper around it.
 * imap_fetch.c: used the above function to do all output pre-loaded

 Revision 573.29  2000/11/25 09:36:18  error
 * Added a bit of detail to syslog entries; now shows session id attached to
   client, hostname, and username, and time the session ended.

 Revision 573.28  2000/11/25 06:17:06  ajc
 * Minor IMAP tweaks.  It still doesn't work.  :(

 Revision 573.27  2000/11/23 07:22:21  error
 * citadel.spec: update version number

 Revision 573.26  2000/11/21 11:12:56  error
  * domain.h: changed the HP/UX compatibility code to use defines from
    typesize.h for integers of specific bit widths (needed for Solaris, etc)

 Revision 573.25  2000/11/12 04:20:49  ajc
 * Optimized server side input of message text

 Revision 573.24  2000/11/10 03:55:06  ajc
 * Ford's Fix for Faster Functionality (save position during reply)

 Revision 573.23  2000/11/09 04:48:50  ajc
 * tools.c: striplt() strips all whitespace, not just spaces

 Revision 573.22  2000/11/07 20:47:21  ajc
 * imap_fetch.c: added a skeleton "ENVELOPE" fetch.  Currently sends NIL's.

 Revision 573.21  2000/11/07 15:54:53  ajc
 * xx FETCH n:n BODY[pn.MIME] now works

 Revision 573.20  2000/11/06 05:10:01  ajc
 * Changed the mime_parser() API (again) to allow "don't decode" mode

 Revision 573.19  2000/10/29 18:11:07  ajc
 * Start numbering top-level MIME parts as 1, 2... not 1.1, 1.2...

 Revision 573.18  2000/10/28 14:14:19  error
 * msgbase.c: eliminated most gotos; a single goto in alias() remains because
   it actually makes sense to do it that way...

 Revision 573.17  2000/10/25 21:37:09  ajc
 * Implemented the AUTHENTICATE LOGIN command in IMAP

 Revision 573.16  2000/10/25 19:20:37  ajc
 * FETCH now works for ranges *and* sets, and with sequence numbers *and* UID's

 Revision 573.15  2000/10/24 20:39:59  ajc
 * Added RFC822, RFC822.HEADER, RFC822.SIZE, RFC822.TEXT fetch keys to IMAP

 Revision 573.14  2000/10/23 20:26:51  error
 * War on goto:  rewrote a few easy functions to eliminate unnecessary gotos

 Revision 573.13  2000/10/11 23:03:44  error
 * utilsmenu: obey $PAGER environment var, if any.  Default to more if neither
   $PAGER nor less is available.

 Revision 573.12  2000/10/11 22:55:25  error
 * citadel.c: when ansi_color=user, enable color at login, so Lobby> posts
   displayed at login are in color

 Revision 573.11  2000/10/11 22:47:51  error
 * domain.c: getmx() returns hostname as MX if no MX records found a la RFC 974

 Revision 573.10  2000/10/10 19:18:12  ajc
 * Added support of macros ALL, BODY, FAST, and FULL to the IMAP FETCH command

 Revision 573.9  2000/10/06 03:31:55  ajc
 * Mark Crispin is a fscking idiot.  IMAP is a convoluted mess.

 Revision 573.8  2000/10/05 22:23:16  ajc
 * Slowly and painfully writing IMAP support

 Revision 573.7  2000/10/04 22:39:06  ajc
 * Added skeleton versions of the LIST and LSUB commands to the imap server

 Revision 573.6  2000/10/04 17:48:21  ajc
 * Allow Aides to zap rooms (site configurable setting)

 Revision 573.5  2000/10/03 01:45:00  ajc
 * Changed the <.A>ide <S>ysconfig <G>eneral command to explicitly allow the
   global page log room to be disabled (answer "no" to set the log room to a
   null string)

 Revision 573.4  2000/09/28 10:27:38  error
 * commands.c: changed sttybbs() to support HP/UX termios VMIN and VTIME

 Revision 573.3  2000/09/24 22:01:45  ajc
 * ipc_c_tcp.c: don't hardcode BBSDIR path for unix domain sockets

 Revision 573.2  2000/09/21 04:16:44  ajc
 * Fixed logged_in_response() so it only displays responses during Citadel
   protocol sessions.  (This was affecting POP etc.)

 Revision 573.1  2000/09/11 22:05:04  ajc
 * citadel.c: accept -h <host> and -p arguments, so citadel can be called
   directly by telnetd, bypassing /bin/login.  It works, but not recommended at
   this time because it has to run as root.

 Revision 573.0  2000/09/05 18:35:22  ajc
 * Tagged everything for version 5.73 release

 Revision 572.39  2000/09/04 03:59:15  ajc
 IO's changes:
 ----------------------------
 revision 572.4
 date: 2000/09/03 06:36:01;  author: error;  state: Exp;  lines: +5 -1
 Added HP/UX linker flag for dynamic modules to work
 ----------------------------
 revision 572.3
 date: 2000/09/01 06:50:00;  author: error;  state: Exp;  lines: +8 -1
 Changed to use integer macros from typesize.h for specific bit widths
 ----------------------------

 Revision 572.38  2000/09/01 20:17:08  ajc
 * msgbase.c: cmd_opna() - increase desired_section buffer from 64 to 256 bytes

 Revision 572.37  2000/09/01 17:31:47  ajc
 * Fixed oopseth in control.c that might call fileno(NULL)

 Revision 572.36  2000/09/01 13:37:16  ajc
 * control.c: chown citadel.control to bbsuid when opening/creating as root

 Revision 572.35  2000/09/01 03:55:44  ajc
 * Fixed a few more references to the deprecated uncnsrd.mt-kisco.ny.us name

 Revision 572.34  2000/09/01 03:43:09  ajc
 * Added 'author' command-line arg to aidepost.  Closes enhancement request
   #71 on bugzilla.
 * Put the default SMTP and POP3 ports back to 25 and 110.  Now that the
   unix domain socket bug is fixed, it's ok if these binds fail.

 Revision 572.33  2000/08/31 23:02:15  ajc
 * ig_tcp_server() and ig_uds_server()  -  check to make sure queue length is
   always at least 5.  Zero-length queues can cause connection lockups.

 Revision 572.32  2000/08/31 21:32:44  ajc
 * Still trying to fix a socket connect bug

 Revision 572.31  2000/08/31 16:37:08  ajc
 * docs/import-export.txt: added.

 Revision 572.30  2000/08/28 19:51:51  ajc
 * messages.c: cosmetic cleanup (coding convention and comments)

 Revision 572.29  2000/08/26 20:23:18  ajc
 * Finished up the back end code for mailing list sends.  Sends now work!

 Revision 572.28  2000/08/24 02:48:18  ajc
 * Merged in IO ERROR's diffs to make Citadel work with HP/UX

 Revision 572.27  2000/08/22 02:31:47  ajc
 * nonce (for APOP-style auth) is now generated when a context is created
   instead of during protocol greeting functions.
 * Moved Citadel protocol nonce output from greeting to INFO

 Revision 572.26  2000/08/18 21:09:36  ajc
 * Added a little more mailing list code to serv_network.c

 Revision 572.25  2000/08/10 04:36:25  ajc
 * Fixed a bug in keyboard polling (in commands.c) which was causing the
   client protocol to get out of sync in certain conditions.

 Revision 572.24  2000/08/10 02:42:13  ajc
 * Changed all the "200 ok" responses to more descriptive strings
 * Added a *temporary* protocol sync check.  Remove this!

 Revision 572.23  2000/08/09 17:14:34  ajc
 msgbase.c: fixed a bug in
            remove_any_whitespace_to_the_left_or_right_of_at_symbol() that was
            causing the <R>eply function to fail on names with whitespace in
            certain parts of the string.  This closes Bug #56.

 Revision 572.22  2000/08/05 04:24:00  ajc
 * Added [idle] to client wholist display for sessions idle >15 minutes
 * Added a generic "void *userdata" field to CtdlForEachMessage()
 * More prep for mailing list handling in the server

 Revision 572.21  2000/07/30 04:36:12  ajc
 * Set up the SNET (Send NETwork config) and GNET (Get NETwork config) commands
   for the network overhaul.

 Revision 572.20  2000/07/29 05:29:19  ajc
 * Changed the format of RWHO output to provide non-masqueraded user/room/host
   names (to Aides only) as additional fields rather than an extra line of
   output.
 * Changed the client to display new RWHO fields, in the "long" wholist only.
 * Default SMTP and POP ports are now -1, not 25/110.  These services must now
   be activated manually.

 Revision 572.19  2000/07/24 00:39:13  ajc
 * Fixed a path problem when calling netmailer from mailinglist.c

 Revision 572.18  2000/07/22 03:44:17  ajc
 * Prepared infrastructure for the networker rewrite

 Revision 572.17  2000/07/17 02:38:08  ajc
 * Completed serv_vandelay.c (importer/exporter module)
 * sendcommand.c: fix behavior of SEND_LISTING mode
 * sysdep.c: client_gets() fill buffer with "000" terminator when returning -1

 Revision 572.16  2000/07/14 03:06:55  ajc
 * Added .ATN (DOWN) and .ATS (SCDN 1) commands to the client

 Revision 572.15  2000/07/10 23:36:08  ajc
 * Another attempt to fix the crashy crashy bug in serv_vcard
 * Did more work on the Art Vandelay module
 * Replaced all instances of sprintf(tempfile, tmpnam(NULL)) with strcpy()

 Revision 572.14  2000/07/10 04:01:12  ajc
 * added an unfinished serv_vandelay.c (Art Vandelay module - importer/exporter)

 Revision 572.13  2000/07/09 02:47:40  ajc
 * Overhauled the keepalive logic in the chat client.  Closes bug #20.

 Revision 572.12  2000/07/09 02:27:02  ajc
 * Eliminated the whole SIGINT/SIGQUIT based handling of Ctrl-O and Ctrl-C
   keyboard interrupts.  Replaced with a non-blocking check for keyboard input
   which sets the global variable 'sigcaught' if either key was pressed.
   fmout() and pprintf() switch to 'drain mode' if sigcaught is set.
   This closes Bug #18.

 Revision 572.11  2000/07/06 20:26:36  ajc
 * updated .Help SUMMARY

 Revision 572.10  2000/07/04 20:02:46  ajc
 * Fixed potential crashy crashy bug in serv_vcard.c

 Revision 572.9  2000/06/28 03:42:56  ajc
 * Changed the comments at the beginning of each file to a consistent format
 * Improved the parameterization of commands in the IMAP module

 Revision 572.8  2000/06/27 01:27:13  ajc
 * Coupla very small changes to get on the road to IMAP support

 Revision 572.7  2000/06/22 21:41:48  ajc
 * Made the ICQ stuff far more reliable ... by removing it!

 Revision 572.6  2000/06/21 03:46:20  ajc
 * IMAP is now legal but useless, supporting NOOP, LOGIN, and LOGOUT.

 Revision 572.5  2000/06/15 20:15:52  ajc
 * Inserted a skeleton IMAP module into the build.  IT DOES NOT WORK AT ALL.

 Revision 572.4  2000/06/04 02:30:56  ajc
 * CtdlForEachMessage() now returns the number of messages processed.  It also
   accepts the MSGS_EQ mode, for targeting a specific message number (useful
   for determining whether the specified message actually exists in a room).
 * Completed the server side of the moderation system (serv_moderate.c module
   which implements the MMOD command)

 Revision 572.3  2000/06/03 05:47:57  ajc
 * Replaced most of the very repetitive and very redundant access level checks
   in most commands with a single API call:  CtdlAccessCheck()
 * serv_moderate.c: added (not finished)

 Revision 572.2  2000/06/02 03:38:50  ajc
 * Bind unix socket prior to TCP socket for citadel protocol
 * Fixed bug in sendcommand.c which was causing it to crash on attach

 Revision 572.1  2000/05/26 19:27:51  ajc
 * Changed some of the rev-level sensitive stuff to look at the actual version
   of Citadel running, not the last version with which we ran setup
 * Added a moderation system.  Default filter level for new users is in the
   config file.  Per-user setting is in usersupp.  Moderation level of each
   message is in SuppMsgInfo.  Tweaked CONF, GETU, and SETU.  Read filter is
   working.  Moderate message up/down commands are not here yet.  See
   techdoc/moderation.txt for more info.

 Revision 572.0  2000/05/23 02:09:30  ajc
 * Updated docs and tagged everything for the 5.72 release

 Revision 571.7  2000/05/20 23:28:20  ajc
 * Fixed bug in client API that was causing netproc to crash

 Revision 571.6  2000/05/15 00:05:19  ajc
 * Double the retry interval for SMTP deliveries after each failed attempt.

 Revision 571.5  2000/05/11 03:08:47  ajc
 * serv_smtp.c: clear the relevant state buffers after an SMTP DATA command
   completes, allowing multiple messages in one session.  Closes bug #58.

 Revision 571.4  2000/04/24 03:36:43  ajc
 * Removed references to strucmp() and struncmp(), replaced them with
   strcasecmp() and strncasecmp() as we did in the server a while ago, and
   set up the config script to figure out whether they need to be compiled
   in.  Also moved them to tools.h
 * Wrote a password manager for the client

 Revision 571.3  2000/04/19 03:17:10  ajc
 * Don't ever expire the Local System Configuration> room

 Revision 571.2  2000/04/16 19:03:47  ajc
 * Minor changes to avoid host lookup for local clients

 Revision 571.1  2000/04/15 19:55:52  ajc
 * Fixed "Unvalidated users appear even with registration disabled" bug #36

 Revision 571.0  2000/04/13 02:43:24  ajc
 * Fixed a problem that crashed the client during <G>oto commands if a room
   existed with a name more than 32 characters (thanks to Magus for reporting
   this one).
 * Tagged everything and updated docs for the 5.71 release

 Revision 570.18  2000/04/10 01:47:22  ajc
 * More paginator changes.  Shuffled code around, added pagination to a bunch
   of other functions, and replaced the old, cumbersome pagination with the
   new, easy, API-based one in everything except message output.

 Revision 570.17  2000/04/09 17:51:18  ajc
 * Added pprintf() (paginated version of printf) to the client-side API.  Now
   any client side function can be paginated simply by changing all of the
   printf's to pprintf's.  I've already done this for the user list and wholist
   (removing the old style pagination) and for "read directory."

 Revision 570.16  2000/04/08 04:52:48  ajc
 * Another minor stoopid little time display fix

 Revision 570.15  2000/04/08 03:58:12  nbryant
  * backed out the previous changes since they didn't look good on some
    xterms with a blue bold mode. just set the background color to black
    instead. this makes black-on-white terminals actually readable, if not
    particularly good looking.

 Revision 570.14  2000/04/08 01:36:30  nbryant
  * citadel.c, commands.c: comment out cls() as this wasn't called if
    ansi_color=user anyway, and we have no way of knowing whether the user's
    terminal does background color erase, which was the reason for adding this
    in the first place. with the recent changes to color(), the display will get
    screwed up if they *do* have background color erase. perhaps this is a job
    for terminfo.

 Revision 570.13  2000/04/08 00:37:42  nbryant
  * commands.c: fix color support for black-on-white color terminals such as
    CDE's dtterm. this just avoids white-on-white text; some color combinations
    such as yellow-on-white still aren't very legible due to contrast. There's
    not much I can think to do about that without affecting the look on the
    white-on-black terminals which probably account for most users.

 Revision 570.12  2000/04/07 20:22:34  ajc
 * Fixed am/pm bug in time display

 Revision 570.11  2000/04/07 19:22:45  ajc
 * For services disabled by setting port number to -1, administratively skip
   the bind instead of just allowing it to fail.

 Revision 570.10  2000/03/31 04:31:02  ajc
 * Quick fix to 'stats' utility to purge records with bogus timestamps

 Revision 570.9  2000/03/31 02:10:52  ajc
 * Caved in to pressure and enabled <R>eply in public rooms.

 Revision 570.8  2000/03/28 03:55:53  ajc
 * Modified <.RU> to allow search for partial match

 Revision 570.7  2000/03/27 03:08:19  ajc
 * Third parameter of CtdlDeleteMessages() now takes "" instead of NULL to
   specify 'any MIME type'.

 Revision 570.6  2000/03/27 01:14:08  nbryant
  * Makefile.in: generate parsedate.c automatically
  * configure.in: check for bison/byacc/yacc. bison seems to build cleaner
    code.
  * parsedate.c: removed from CVS
  * parsedate.y: added #include <stdlib.h> so it builds with bison

 Revision 570.5  2000/03/27 00:46:10  nbryant
  * First cut at Solaris fixes. There may still be some *printf("%s", NULL)
    type of issues lurking in the shadows.

 Revision 570.4  2000/03/25 18:29:58  nbryant
 changed my email address

 Revision 570.3  2000/03/23 02:41:50  ajc
 *** empty log message ***

 Revision 570.2  2000/03/21 03:23:24  ajc
 * Experimental new linebreak mode

 Revision 570.1  2000/03/20 14:43:19  ajc
 * "Brown paper bag" fix for SMTP bug (incoming long fields crash logger)

 Revision 570.0  2000/03/19 23:42:34  ajc
 * This is the official 5.70 release.

 Revision 1.494  2000/03/19 23:04:08  ajc
 * Small cosmetic change to date/time output

 Revision 1.493  2000/03/19 05:02:39  ajc
 * SMTP hacks to deal with AOL braindamage

 Revision 1.492  2000/03/18 18:18:04  ajc
 * Support multiline responses from SMTP servers when sending mail

 Revision 1.491  2000/03/17 16:26:57  ajc
 * Set up a private "Sent/Received Pages" room for each user

 Revision 1.490  2000/03/17 04:11:24  ajc
 * Moved bio-related commands out to a loadable module

 Revision 1.489  2000/03/16 17:58:54  smw
 Created a docs directory.
 Moved install.txt to docs.
 Added inetmailsetup.txt (BBS server side e-mail)
 Added inetmailsetupmx.txt (local mail AND bbs e-mail
 Added inetsiteconfig.txt (describes the .asi command)
 Added siteconfig.txt (describes .asg)
 Added chat.txt (describes changes and new chat functionality)
 Made a couple of changes to install.txt (references to new documentation)
 Added Steve Williams to copyright.txt as the document writer.

Revision 1.488  2000/03/15 03:04:51  ajc
* Added DEXP server command to disable incoming express messages.
* <Q>uiet mode client side command to set/clear DEXP mode.
* <K>nown rooms list displays through the paginator.

Revision 1.487  2000/03/12 00:21:35  ajc
* Removed the semi-broken "chat room" functionality in the chat system, and
  replaced it with direct mapping to the actual Citadel room the user is in.
* Display masqueraded roomname in chat, if applicable.  Fixes bug #19.

Revision 1.486  2000/03/11 21:29:37  ajc
* SM_ flags for CtdlSaveMsgPointerInRoom() need to be a bit bucket, not an
  enum, since more than one can be passed.  Changed SM_DONT_BUMP_REF_COUNT
  from 3 to 4.  This also fixes bug #33.

Revision 1.485  2000/03/11 20:26:03  ajc
* Reworked the <R>eply logic in messages.c - fixes bug #34

Revision 1.484  2000/03/11 19:22:19  nbryant
 * commands.c: improved timing of background keepalives if connection is
               lagged

Revision 1.483  2000/03/11 05:08:48  nbryant
 * commands.c: oops, that mutex stuff wasn't necessary

Revision 1.482  2000/03/11 04:09:03  nbryant
 * new threaded client code for background keepalives

Revision 1.481  2000/03/10 21:40:04  ajc
* Changes to message base and networker to support Internet-style message
  ID's instead of the conventional Citadel style.

Revision 1.480  2000/03/08 03:36:37  ajc
* Shut off hostname resolution when dealing with Unix domain sockets
* Cleaned up the 'citmail' MDA tool
* Added POP3 and SMTP port numbers to global system configuration

Revision 1.479  2000/03/07 21:54:58  ajc
* Fixed the naming conventions and permissions for unix domain sockets.

Revision 1.478  2000/03/05 07:33:23  ajc
* Added support for protocols over Unix domain sockets.

Revision 1.477  2000/03/04 22:36:23  ajc
* Remove nulls appended to editor files during replace, edit, and print
  operations.  Truncate temp files during same operations.
  Closes bugs #6 and #7.

Revision 1.476  2000/03/04 05:29:18  ajc
* Relax restrictions on editing of base rooms.  Renaming is not allowed but
  all other attributes can be edited.  Closes feature request #21.
* Sending pages from the client now uses the same message editing functions
  as entering messages, allowing edit/abort.  Closes feature request #25.

Revision 1.475  2000/03/03 04:50:14  ajc
* Moved all of the wholist masquerading commands into the serv_rwho module

Revision 1.474  2000/03/03 04:12:37  ajc
* Finished the inbound side of gateway domain service

Revision 1.473  2000/02/27 04:55:51  ajc
* Added "keymenu()" generic menu-maker to commands.c
* Blocked non-numeric input to intprompt()  (fixes bug #16)

Revision 1.472  2000/02/27 03:57:35  ajc
* Completed 'fsck'-like reference count verifier (server and client)

Revision 1.471  2000/02/26 18:30:40  ajc
* Properly handle all aliases specified in network/mail.aliases for incoming
  SMTP mail (uses the alias() function, so if we replace that function with
  something that uses the same calling convention, it'll still work)

Revision 1.470  2000/02/26 05:15:38  ajc
* Fortified the message base and SMTP code so that misdirected bounce messages
  end up in the Aide> room instead of getting dereferenced
* Started writing a message reference count verifier ('fsck' for message base)

Revision 1.469  2000/02/25 06:14:05  ajc
* Modularized the RWHO (Read WHO is online) command, basically as a pilot
  for modularizing all "non-API" functionality.

Revision 1.468  2000/02/24 03:44:00  ajc
* Implemented holdoff time (15 minutes) for SMTP send retry.
* Implemented "try for 3 days and then give up" on SMTP send.

Revision 1.467  2000/02/24 00:51:48  ajc
* Client protocol synchronization check during exit from chat.
  This closes Bug #15.

Revision 1.466  2000/02/22 16:37:28  ajc
* Minor tweaks to RFC822 output to keep brain-damanged MS Outlook from dying

Revision 1.465  2000/02/22 04:17:56  ajc
* Got bounce messages working (mostly ... testers, please beat this up!)
* Changed 'FIX' comments to 'FIXME' (less conflict, plus vim highlights it!)

Revision 1.464  2000/02/18 22:29:18  ajc
* Coded up the "bounce" functions.  Still a coupla bugs.

Revision 1.463  2000/02/18 05:10:50  ajc
* Made the <.ASI> command a bit friendlier.
* SMTP sender now pays attention to "smarthost" entries in the system's
  Internet configuration, using them if one or more is present.

Revision 1.462  2000/02/17 05:27:39  ajc
* Got the "MAIL From:" command sending the correct data.  (unnnhhhhnnhhhh...)

Revision 1.461  2000/02/16 22:06:26  ajc
* Altered the display and conversion of RFC822 messages

Revision 1.460  2000/02/16 03:43:28  ajc
* Added the resolver library to the configure script

Revision 1.459  2000/02/16 01:19:39  ajc
* Vanquished the evil dn_expand() beast.  getmx() now seems to be working.

Revision 1.458  2000/02/14 04:36:14  ajc
* sysdep.c: added new event hook type EVT_TIMER.  Timer event hooks are called
  once per minute by any worker thread.
* msgbase.c: removed dependence on nested functions in CtdlOutputMsg() by
  replacing them with an API call CtdlRedirectOutput() in sysdep.c, which
  can temporarily redirect a session's output to an arbitrary file or socket.
* serv_smtp.c: implemented the purging of messages in the queue for which all
  deliveries have been completed.
* serv_smtp.c: removed temporary 'QQQQ' server command and replaced it with
  a timer event hook that runs the queue once per minute (this needs to be
  made more robust)

Revision 1.457  2000/02/08 21:00:47  ajc
* Implemented the deprecated "LAST" command in POP3.  Some clients need it.
* POP3 sessions now set the last-read pointer in Mail>.

Revision 1.456  2000/02/07 05:15:00  ajc
* Renamed CtdlLocalHost() to CtdlHostAlias() and worked it a little deeper into
  the message routing logic.  Still needs some work on the gateway-domain
  stuff.
* Twiddled CtdlOutputMsg() a bit for 'all Internet' situations.  Still needs
  some work to avoid printing dual headers when both Cit and RFC822 exist.

Revision 1.455  2000/02/03 03:57:35  ajc
* Formalized the 'Internet Configuration' logistics.  Added new API call
  CtdlLocalHost() to detect aliases for the local host.  Used in SMTP listener.

Revision 1.454  2000/01/31 02:13:05  ajc
* <.A>ide <S>ystem configuration <I>nternet  in the client (unfinished)

Revision 1.453  2000/01/26 02:41:27  ajc
* SMTP delivery is working but still *very* rough.

Revision 1.452  2000/01/25 04:45:50  ajc
* Wrote enough of the SMTP sender to get Patriot drooling over it, but not
  enough to complete the transmission of mail.

Revision 1.451  2000/01/23 21:25:45  ajc
* Temporary hack to ig_tcp_server() to listen on an arbitrary port if the
  one specified is not bindable (for development only)
* Added SM_DONT_BUMP_REF flag to CtdlSaveMsgPointerInRoom() to be used only
  in very specific and special situations
* Generate delivery instructions when outbound SMTP mail is created from
  within Citadel (as opposed to being from the SMTP module)

Revision 1.450  2000/01/23 05:22:41  ajc
* Coded up some more of the SMTP-sender (still not done)

Revision 1.449  2000/01/22 05:13:56  ajc
* Added some more functionality to the string tokenizer

Revision 1.448  2000/01/17 20:57:43  ajc
* CR to CRLF hacks (lose, lose, lose)

Revision 1.447  2000/01/17 18:30:27  ajc
* Completed POP3 server.  All RFC1939 commands except APOP are implemented.

Revision 1.446  2000/01/17 17:09:23  ajc
* Implemented LIST and STAT commands in the pop3 server

Revision 1.445  2000/01/17 05:38:14  ajc
* citserver.c: cleanup hook functions are now run under the proper context,
               even when initiated by the housekeeper thread
* serv_pop3.c: establish a place to hold the message list

Revision 1.444  2000/01/17 04:26:39  ajc
* Modified CtdlOutputMsg() to handle output to arbitrary sockets or files.
  This uses nested functions and may not be portable beyond GCC...

Revision 1.443  2000/01/15 18:29:15  ajc
* Added a generic (void *) parameter to the ForEachUser() and ForEachRoom()
  callback mechanisms, to allow callers and callbacks to pass arbitrary data
  between each other without requiring TSD variables.
* room_ops.c: eliminated the need for 'FloorBeingSearched' TSD variable
* internet_addressing.c: eliminated 'buffer1' and 'buffer2' TSD variables

Revision 1.442  2000/01/15 04:31:44  ajc
* Removed UI_DIALOG mode in setup.  Can't count on 'dialog' to be consistent.

Revision 1.441  2000/01/15 04:07:17  ajc
* Fixed the access rights on auto-created rooms (the same changes that were
  made to version 5.62 in the stable tree)

Revision 1.440  2000/01/13 03:32:36  ajc
* techdoc/delivery-list.txt: added (syntax for delivery lists)
* domain.*: added (will contain MX lookup code)
* internet_addressing.c, logging.c: fixed some buffer overflow bugs

Revision 1.439  2000/01/12 03:56:27  ajc
* sysdep.c: start the housekeeping thread *after* dropping root perms.

Revision 1.438  2000/01/09 19:03:16  ajc
* Removed the fifo-based protocol downloads and replaced it with a less
  elegant "download temporary file to client, then sx/sb/sz" because
  downloading through a fifo was confusing some software.

Revision 1.437  2000/01/08 22:19:44  ajc
* Completed spool to outbound delivery queue (still no queue sender implemented)

Revision 1.436  2000/01/08 05:00:09  ajc
* Reworked some of the data structures to handle multiple recipients
* Began implementation of the delivery queue
* Added CtdlReallocUserData()
* CtdlSaveMsg() now returns the local message ID in the database

Revision 1.435  2000/01/06 03:50:34  ajc
* Replaced citmail.c with a new one that simply SMTP-forwards to Citadel
* Started outbound SMTP queue work

Revision 1.434  1999/12/30 04:56:29  ajc
* Got initial SMTP delivery working in a very specific situation (delivery
  to a single, local user)

Revision 1.433  1999/12/29 04:44:00  ajc
* client_chat.c: display "No message sent" if a send page is aborted.
  Closes bug #2 in bugzilla.

Revision 1.432  1999/12/26 21:50:07  ajc
* serv_vcard: don't run hooks when not logged in (such as in SMTP sessions)
* serv_pop3: added.  This is the skeleton for a module implementing POP3.

Revision 1.431  1999/12/23 04:46:23  ajc
* "Finished" initial hack of RFC822 import

Revision 1.430  1999/12/22 04:46:34  ajc
* Fixed up the "Date:" headers to be RFC822-compliant

Revision 1.429  1999/12/13 05:30:57  ajc
* Removed our naive 'conv_date()' RFC822-to-unixtime conversion function
  and replaced it with the public domain 'parsedate()' function from UseNet

Revision 1.428  1999/12/10 23:58:25  ajc
* internet_addressing.c: added.  (Internet address to Citadel mapping)

Revision 1.427  1999/12/10 21:34:19  ajc
* serv_smtp: implemented RFC821 "VRFY" and "EXPN" commands

Revision 1.426  1999/12/09 05:01:14  ajc
* Split cmd_user() and cmd_pass() into frontend/backend functions
* serv_smtp: implemented AUTH LOGIN for client authentication

Revision 1.425  1999/12/09 00:22:58  ajc
* Finished the "arbitrary service" registration.
* Eliminated "special" master socket for Citadel protocol - just register it
  like any other protocol.
* Began initial implementation of native SMTP service.

Revision 1.424  1999/12/08 18:09:10  ajc
* Added CtdlRegisterServiceHook() and its data type, for implementing arbitrary
  TCP-based services directly in the Citadel server.  Not finished yet.

Revision 1.423  1999/11/29 17:39:07  nbryant
* citserver.c: Solaris lacks inet_aton; use inet_addr instead

Revision 1.422  1999/11/29 17:26:15  nbryant
* citserver.c: include <sys/types.h>; may help portability to Solaris

Revision 1.421  1999/11/22 00:27:42  ajc
* Added some temporary variables to OpenCmdResult().  Hopefully fixes
  bug #14 when running on FreeBSD.

Revision 1.420  1999/11/21 18:30:16  ajc
* Protected cmd_move() from buffer overrun (no longer crashes the server)
* cmd_chat() -- truncate input at 100 characters to prevent buffer overruns.
  Also handle broken client sockets properly.  (Thanks to DME for bug report)

Revision 1.419  1999/11/19 01:57:40  ajc
* Fixed a *serious* memory leak in the database function wrappers.
* Updated version number to 5.60 -- run setup when installing this version.

Revision 1.418  1999/11/18 03:29:20  ajc
* Changed the order of parameters in <.A>ide <S>ystem config into a more
  logical grouping.

Revision 1.417  1999/11/18 02:31:50  ajc
* Updated some of the documentation
* Brought the internal version number up to 5.60

Revision 1.416  1999/11/17 04:15:05  ajc
* Removed the session_count() function.  Instead, keep a reference count
  updated when sessions begin and end.
* Replaced fixed number of worker threads with lower and upper limits; current
  code now tries to make thread count == session count, within these limits

Revision 1.415  1999/11/15 03:17:39  ajc
* Put lockfile in /tmp instead of in /var/lock.   The latter is not guaranteed
  to exist, nor is it guaranteed to be writable by BBSUID
  (Resolves bug #11 from the Bugzilla repository)

Revision 1.414  1999/11/15 03:07:24  ajc
* Fixed the network-wide vCard purge logic so that it (1) actually works,
  and (2) forces a netproc run immediately when a purge is entered

Revision 1.413  1999/11/09 21:20:44  nbryant
* configure.in: include <sys/types.h> when doing checks which require <utmp.h>
  (should fix Bug #10 on FreeBSD)

Revision 1.412  1999/11/05 03:53:47  ajc
* Issue 'cancel' messages for vCard when a user is deleted.
* Try to delete 'cancel' messages locally after they've been distributed.

Revision 1.411  1999/11/03 04:01:20  ajc
* Fixed buffer overrun problems in cmd_rchg(), cmd_hchg(), and cmd_uchg()
* Removed my email address as the feedback content from the docs; replaced
  it with a reference to the Citadel/UX web site.

Revision 1.410  1999/11/02 19:51:23  ajc
* Fixed timeout problem for remote client sessions (all timeouts were set to
  1 second ... probably a temporary hack that was missed in the cleanup)

Revision 1.409  1999/11/02 03:03:27  ajc
* Several fixes to msgbase.c and netproc.c to prevent corrupted incoming
  network traffic from crashing the server.  Reject bad messages.

Revision 1.408  1999/11/01 04:21:34  ajc
* Fixed a concurrency bug which crashed the server when multiple sessions
  terminated simultaneously.

Revision 1.407  1999/11/01 00:54:02  ajc
* CtdlFetchMessage() - generate a "<no text>" message body if there's none
  on disk.  Too much stuff goes haywire if there's no M field.

Revision 1.406  1999/10/31 18:17:17  ajc
* Fixed buffer overrun in cmd_rchg()
* Call master_cleanup() when time_to_die==1 for proper shutdown

Revision 1.405  1999/10/31 16:26:55  ajc
* Fixed incorrect assignment of new session ID's

Revision 1.404  1999/10/31 04:17:17  ajc
* Fixed a bug which was crashing the server during very long message entry.

Revision 1.403  1999/10/29 01:48:45  ajc
* database.c: Removed arbitrary limit on maximum number of sessions

Revision 1.402  1999/10/29 01:03:03  ajc
* Debugged all possible ways for a session to terminate; do them cleanly.
* Assign session numbers in a more portable and less arbitrary way.

Revision 1.401  1999/10/28 19:50:55  ajc
* Fixed a problem where the client protocol would spit out two responses
  and therefore get out of sync if ASUP command set the access level to
  0 and therefore deleted the user (thanks to Eric McDonald)

Revision 1.400  1999/10/28 05:08:49  ajc
* Removed all of the thread cancellation cruft that is no longer necessary
* Moved the now non-system-dependent RemoveContext() out of sysdep.c (now
  it's part of cleanup() in citserver.c)
* Removed all references to pthread_* from all modules except sysdep.c

Revision 1.399  1999/10/28 03:20:17  ajc
* Fixed the problem of worker threads waking up prematurely.
* 'QUIT'-terminated sessions now exit properly.

Revision 1.398  1999/10/27 04:26:58  ajc
* Initial hack of worker-thread rearchitecture.  Right now it is successfully
  dispatching worker threads to active client sockets (and to the master
  socket too, of course).  Removing sessions is currently broken.

Revision 1.397  1999/10/26 20:20:29  ajc
* Removed the auto-reconnect stuff... it was locking the client in an active
  loop more often than it was reconnecting.

Revision 1.396  1999/10/26 13:59:11  ajc
damn bugs

Revision 1.395  1999/10/26 03:48:39  ajc
* Shuffled around the order of events when a thread is terminating.  All
  mutex operations now happen prior to the freeing of the CitContext structure,
  otherwise begin_critical_section() and end_critical_section() try to
  manipulate the context's mutex count when there isn't any context.

Revision 1.394  1999/10/26 03:21:16  ajc
* Changed a lot of strncpy() calls to safestrncpy() and replaced most of their
  hardcoded size arguments with 'sizeof' based arguments.

Revision 1.393  1999/10/24 19:22:51  nbryant
	* Makefile.in, configure.in: added --enable-icq flag; made checks for
	  authentication libraries more intelligent.

Revision 1.392  1999/10/23 03:39:12  ajc
* Finished moving vCard functionality to the new message base functions.

Revision 1.391  1999/10/21 00:50:14  ajc
* Finished up the flags and replication checks in CtdlSaveMsgPointerInRoom().

Revision 1.390  1999/10/20 16:46:27  ajc
* More code shuffle.  Added some flags to CtdlSaveMessagePointerInRoom() and
  enabled the MOVE command to also do a "copy" operation (actually just
  creates a second link and bumps the ref count).  Implemented "<C>opy" in
  the client.

Revision 1.389  1999/10/20 16:07:48  ajc
* Wholist fixes for users who are in chat mode

Revision 1.388  1999/10/20 03:42:29  ajc
* In the wholist, only show <private room> if the user viewing the list
  doesn't know that room.  Otherwise show the name.

Revision 1.387  1999/10/20 02:59:22  ajc
* Code reorganization.  Making it easier to move/copy messages without
  duplicating existing code.

Revision 1.386  1999/10/17 02:25:18  ajc
* Discovered a huge design flaw in the replication algorithm.  Ripped it
  out and replaced it with something a bit more robust.

Revision 1.385  1999/10/16 05:30:17  ajc
* Changes to message replication code.  Don't do server-side hooks during
  an ENT3 command.  Also fixed a bug in cmd_whok() that caused crashes
  after a file format change.

Revision 1.384  1999/10/14 03:04:16  ajc
* Finished the netproc side of Z (zap/supersede) processing for replication

Revision 1.383  1999/10/13 04:24:18  ajc
* Added search-by-header-fields to CtdlForEachMessage(), and then to the
  server MSGS command.  This will have lots of uses.

Revision 1.382  1999/10/13 01:36:39  ajc
* Starting some work on network zap (supersede) mode for replication

Revision 1.381  1999/10/08 02:55:57  ajc
* More vCard-related debugging

Revision 1.380  1999/10/07 02:58:46  ajc
* Semi-broken vCard replacement implementation in place.
* Added "Z" (Zap, supersede) field to message format

Revision 1.377  1999/10/04 03:19:52  ajc
* We now have a housekeeping thread and a housekeeping queue.

Revision 1.376  1999/10/03 21:48:21  ajc
* Added serv_upgrade.h to automagically convert pre-5.55 format user records
  to 5.55 format user records and generate vCards.

Revision 1.375  1999/09/29 21:13:17  ajc
* CtdlWriteObject() can now store objects in personal rooms for any specified
  user -- rather than only the current user or non-personal rooms.

Revision 1.374  1999/09/29 17:26:56  ajc
* serv_vcard.c: fixed crashola bug in cmd_greg()
* tools.c: simplified and improved the string tokenizer.  Now it runs in a
           single pass with no intermediate buffer.

Revision 1.373  1999/09/28 03:27:37  ajc
* Fully migrated cmd_greg() and cmd_regi() into serv_vcard (still has bugs)

Revision 1.372  1999/09/27 03:33:40  ajc
* cmd_regi() is now in serv_vcard and writes to the vcard instead of to the
  usersupp file.  Still needs tweaking.

Revision 1.371  1999/09/24 03:32:19  ajc
* "read my vCard" and "write my vCard" are written and tested.

Revision 1.370  1999/09/24 02:54:17  ajc
* Worked a little more on the vCard stuff.  The serv_vcard module is now in
  place, and a "read my vcard" function is there; "write my" is next...

Revision 1.369  1999/09/23 03:07:56  ajc
* The vCard 'class' is now linked into the server, though it's not really
  functional yet.  Its constructors/destructors are debugged, though.

Revision 1.368  1999/09/19 21:28:33  ajc
* Finished off the message architecture stuff with a new class of hooks to
  enable future server-side handlers.

Revision 1.367  1999/09/19 15:57:06  ajc
* migrated cmd_ent3() to CtdlSaveMessage()

Revision 1.366  1999/09/19 05:13:57  ajc
* Debugged the new version of CtdlWriteObject()

Revision 1.365  1999/09/16 03:23:23  ajc
* Did most of the migration from save_message() to CtdlSaveMsg().  The
  latter builds a "struct CtdlMessage" (so we can run server-side handlers
  against it later on), then serializes it and stores to disk.
* BROKEN BUILD ALERT!!  cmd_ent3() and CtdlWriteObject() are still not
  migrated.  They are stubbed out and will MALFUNCTION if used right now!!

Revision 1.364  1999/09/07 01:42:42  ajc
* cmd_msg3() now uses serialize_message() for its output.  All message
  commands will eventually exist as a "struct CtdlMessage" at some point
  so that we can install server-side handler hooks.

Revision 1.363  1999/09/07 00:04:13  ajc
* netproc.c: put outgoing messages into the use table, too -- this prevents
  locally originated messages from showing up again if a remote system is
  misconfigured and spools them back to us.

Revision 1.362  1999/09/06 03:39:15  ajc
* citadel.c: run strproc() on new passwords

Revision 1.361  1999/09/03 17:50:26  playcow
For URL view, don't prompt user to select url if there is only one.  Display
<U>RL View prompt if message contains url(s). -Ben

Revision 1.360  1999/09/02 02:09:59  ajc
* msgbase.c: new function serialize_message() for future use

Revision 1.359  1999/09/01 21:09:25  ajc
* database.c: display the GDBM version string on startup

Revision 1.358  1999/09/01 02:36:34  ajc
* Actually _enforce_ the max msg len limit

Revision 1.357  1999/09/01 01:51:48  ajc
* Added the ability to handle embedded URL's from the text client

Revision 1.356  1999/09/01 01:02:47  ajc
* Implemented "maximum message length" in global system config

Revision 1.355  1999/08/31 00:57:17  ajc
* Handle multipart/alternative properly during legacy message outputs.
  Basically it just prints the first alternative and skips the rest.

Revision 1.354  1999/08/29 21:12:24  ajc
* Made some changes to the output of MIME (especially multipart) messages.

Revision 1.353  1999/08/29 19:56:43  ajc
* HTML updates

Revision 1.352  1999/08/24 02:01:03  ajc
* html.c: added.  This is an overly simplistic HTML-to-text converter.

Revision 1.351  1999/08/21 18:37:29  ajc
* Minor cosmetic cleanup.  No code changes.

Revision 1.350  1999/08/21 05:15:34  ajc
* mailinglist.c, netmailer.c: fixed to allow list submissions from all posters
  on a Citadel network rather than only on the local system.

Revision 1.349  1999/08/08 00:25:45  ajc
* Made one more byte available in locate_host() and in all the structs which
  its output gets written to (client can display 24 positions but we were only
  saving 23).

Revision 1.348  1999/08/07 16:34:38  nbryant
* serv_icq.c: warning fixes

Revision 1.347  1999/08/06 02:57:26  ajc
* locate_host.c: use strdoop() and phree() instead of strdup() and free()
* serv_icq.c: run learned IP's through Citadel's locate_host() & put in Wholist

Revision 1.346  1999/08/05 17:58:59  ajc
* RWHO command now returns express message code in postion 3

Revision 1.345  1999/08/04 02:21:45  ajc
* Fixed some bugs in the ICQ metaclient, and documented the new protocol cmds

Revision 1.344  1999/08/03 11:34:35  ajc
* Added client_icq.c and client_icq.h

Revision 1.343  1999/08/03 03:14:51  ajc
* Wrote the client side of the ICQ gateway.  Now on to other projects.  :)

Revision 1.342  1999/08/03 01:52:06  ajc
* Redesigned the client protocol commands for dealing with ICQ
* Implemented page function priority ordering to prevent pages from being
  simultaneously delivered over multiple IM systems
* Migrated serv_icq.* into the Makefile

Revision 1.341  1999/08/01 21:36:30  ajc
* EXTREME coolness.  The server side of the ICQ metaclient is now working.
  It is set up using ICQL and ICQA commands, it automatically logs the user
  onto ICQ along with Citadel, and displays all non-offline ICQ contacts
  in the Wholist.

Revision 1.340  1999/07/31 07:18:01  ajc
* Restructured the express message infrastructure, adding a class of function
  hooks for the addition of multiple paging modules with message routing

Revision 1.339  1999/07/30 22:20:19  ajc
* Applied bugfix patches contributed by Vaggelis Tsirkas:
  * rooms.c: buffer overrun fix
  * room_ops.c: cmd_rdir() now behaves better when directory doesn't exist

Revision 1.338  1999/07/30 03:32:24  ajc
* Added strdoop(), a leak-checked version of strdup()
* Small fixes to new API functions in msgbase.c
* ICQ metaclient stores/reads config using the message base API functions

Revision 1.337  1999/07/29 03:36:37  ajc
* msgbase.c: reorganized.  output_message() now uses CtdlFetchMessage(),
  cmd_msg3() now fetches directly from disk and spews to the client.

Revision 1.336  1999/07/28 04:02:37  ajc
* Server modules are now labelled with their RCS ID instead of a complex and
  manually-updated data structure.

Revision 1.335  1999/07/28 03:50:24  ajc
* serv_expire.c: expire-by-age now calls CtdlFetchMessage() instead of
  calling output_message() in MT_DATE mode.
* msgbase.c: removed MT_DATE mode ('twas a sleazy hack)

Revision 1.334  1999/07/27 22:47:26  ajc
* Implemented new data type "CtdlMessage" which will eventually be used as
  widely as possible to represent a message in memory.
* Implemented CtdlFetchMessage() which is intended to become the back-end to
  output_message() as well as a bunch of other things.

Revision 1.333  1999/07/27 20:00:24  ajc
Removed all references to CC->msglist and CC->num_msgs, and all utility
functions which relied upon them.  Citadel Is Now Better.

Revision 1.332  1999/07/27 19:32:22  ajc
Removed serv_upgrade.c and all references to it in Makefile.in
Reworked new-mail-count to not use MessageFromList() etc.

Revision 1.331  1999/07/25 02:59:37  ajc
Fixed reference count problem in cmd_move()

Revision 1.330  1999/07/24 22:50:38  ajc
Continued replacing references to [get|put]_msglist() with better code.
For some reason, cmd_msgs() still doesn't always work right.

Revision 1.329  1999/07/24 22:16:41  ajc
Experimenting with automatic updating of ChangeLog by CVS.  Simply twiddle
ChangeLog a bit (i.e. by adding or removing a newline from the end of the
file) before issusing "cvs commit", and the comments recorded by CVS will
automatically appear at the beginning of ChangeLog.

Revision 1.328  1999/07/24 22:14:21  ajc
cmd_move() now uses CtdlDeleteMessages().
WARNING: build is temporarily broken.  Currently removing all references
to the "msglist" kept in CitContext.  It's ugly and must die.

Thu Jul 22 22:26:50 EDT 1999 Art Cancro <ajc@uncensored.citadel.org>
	* Moved message deletion into new API function CtdlDeleteMessages()
	* Added CtdlWriteObject() to store generic data in the msgbase
	* Fixed really dumb error that prevented network msgs from posting

Tue Jul 20 22:14:54 EDT 1999 Art Cancro <ajc@uncensored.citadel.org>
	* Moved the actual work done in cmd_msgs() into a new API function
	  called CtdlForEachMessage() which is supplied a callback function.

Mon Jul 19 23:24:18 EDT 1999 Art Cancro <ajc@uncensored.citadel.org>
	* Keep the (unqualified) content-type in the SuppMsgInfo record.  We'll
	  be using this shortly to search rooms for specific object types.

Sun Jul 18 14:53:16 EDT 1999 Art Cancro <ajc@uncensored.citadel.org> 
	* Changes to dynloader et al to handle ICQ module being written
	* serv_icq.c, serv_icq.mk: added (separate makefile is temporary)

1999-07-17 Nathan Bryant <bryant@cs.usm.maine.edu>
	* chkpwd.c: DELETED CVS REVISION 1.3 (backed out Art's last change)
	  use 'cvs update -r 1.2 chkpwd.c; cvs update -A chkpwd.c' NOW to
	  avoid problems with working directories.
	* Makefile.in: don't install chkpwd setuid if make install isn't
	  being run as root.
	* citadel.spec: chmod u+s chkpwd during %install stage

Fri Jul 16 18:39:04 EDT 1999 Art Cancro <ajc@uncensored.citadel.org>
	* PEXP and GEXP no longer trip the idle time display
	* Fixed bug which duplicated incoming private mail to Trashcan
	* Improved auto-reconnect by NOT using SIGPIPE and longjmp(); also
	  implemented a 15 second delay to wait for a crashed server to restart
	* Relaxed the security check in chkpwd.c a bit; it was just flat-out
	  preventing logins on my system otherwise

Thu Jul 15 22:57:32 EDT 1999 Art Cancro <ajc@uncensored.citadel.org>
	* eliminate redundant "name" parameter in [l]putuser(), now uses
	  usbuf->fullname to guarantee the correct name for the index

1999-07-12 Nathan Bryant <bryant@cs.usm.maine.edu>
	* Makefile.in, configure.in: link netproc with gdbm
	* netproc.c: only include gdbm.h if HAVE_GDBM_H
	* user_ops.c: warning fix

Mon Jul 12 19:51:30 EDT 1999 Art Cancro <ajc@uncensored.citadel.org>
	* Mail is now saved in both sender and recipient mailboxes.  This is
	  structured in a way that will allow a separate "outbox" room and/or
	  multiple recipients in the future.

Sun Jul 11 18:46:48 EDT 1999 Art Cancro <ajc@uncensored.citadel.org>
	* netproc.c: msgfind() no longer uses the timestamp as a message-ID
	  when no other message-ID is available (it screws up the loopzapper)
	* room_ops.c: eliminate room name parameter in putroom() and its ilk;
	  get data from quickroom.QRname instead; prevents incorrect indexes
	* Tentative implementation of "personal rooms" (user-private namespace)
	* Added supplementary message info records for info that may change
	  at some time later than when the message is saved (i.e. ref counts)
	* Implemented msg reference count increment/decrement; delete messages
	  whose reference count reaches zero

Wed Jul  7 23:25:09 EDT 1999 Art Cancro <ajc@uncensored.citadel.org>
	* control.c: create citadel.control if it doesn't exist (yikes!)
	* serv_expire.c: purge mailbox rooms belonging to non-existent users
	* user_ops.c: don't delete user's mailbox at user-delete time

Mon Jul  5 17:01:29 EDT 1999 Art Cancro <ajc@uncensored.citadel.org>
	* utilsmenu: removed menu items for defunct utilities

Mon Jun 28 16:24:10 EDT 1999 Art Cancro <ajc@uncensored.citadel.org>
	* Changed any remaining references to UUCP, to "Internet" instead.

Thu Jun 24 11:13:23 EDT 1999 Art Cancro <ajc@uncensored.citadel.org>
	* added server command line option "-f" to defrag databases on startup
	* control.c: better performance and reliability in [get|put]_control()
	* netproc.c: Finished the loopzapper

Mon Jun 21 00:04:15 EDT 1999 Art Cancro <ajc@uncensored.citadel.org>
	* netproc.c: started writing a vortex checker.  Not finished.

Wed Jun  9 23:34:25 EDT 1999 Art Cancro <ajc@uncensored.citadel.org>
	* Replaced all code that generated temporary filenames with calls to
	  tmpnam().  Rewrote using tmpfile() where possible.

Thu Jun  3 11:35:18 EDT 1999 Art Cancro <ajc@uncensored.citadel.org>
	* base64.c: mapped fi and fo to stdin and stdout using
	  actual code rather than assignment at declaration time
	  (several users of Red Hat Linux 6.0 reported problems)

Fri May 21 20:05:00 EDT 1999 Art Cancro <ajc@uncensored.citadel.org>
	* Added function CtdlGetDynamicSymbol() for dynamic symbol allocation
	* server.h: Changed discrete #define's to enum's where appropriate
	* sysdep.c: Changed the startup message to give credit to the whole
	  development team :)  Also made the message more GNU-ish.

Thu May 20 20:01:30 EDT 1999 Art Cancro <ajc@uncensored.citadel.org>
	* database.c: print log messages for file defragmentations
	* citserver.c: implemented CtdlAllocUserData() and CtdlGetUserData()
	  for arbitrary per-session data storage (by modules etc.) without
	  having to add fields to struct CitContext
	* msgbase.c: removed "desired_section" from struct CitContext and
	  implemented it using CtdlGetUserData() as a test.

Wed May 19 19:30:28 EDT 1999 Art Cancro <ajc@uncensored.citadel.org>
	* commands.c, commands.h, routines.c: began color scheme changes

1999-05-15 Nathan Bryant <bryant@cs.usm.maine.edu>
	* configure.in: Added untested support for BSDI 4.x.

1999-05-13 Nathan Bryant <bryant@cs.usm.maine.edu>
	* acconfig.h, configure.in, routines.c: fix for certain SYSV variants
	  which lack utmp.ut_host
	* citadel.h, file_ops.c, msgbase.c, netproc.c, serv_chat.c: fix
	  namespace collision with <sys/stream.h> on aforementioned SYSV
	  variant
	* configure.in, getutline.c: check for paths.h
	* configure.in, Makefile.in: check for -lsocket and -lnsl

1999-05-11 Nathan Bryant <bryant@cs.usm.maine.edu>
	* chkpwd.c: fixed excessive paranoia; it used to refuse to run when
	  invoked by root and BBSUID != 0
	* Makefile.in: ignore errors while installing /etc/pam.d/citadel

1999-04-27 Art Cancro <ajc@uncensored.citadel.org>
	* file_ops.c: fixed NDOP to not crash the server if it has trouble
	  with a download file
	* netpoll.c: upped default packet size

Mon Apr 26 22:06:57 EDT 1999 Art Cancro <ajc@uncensored.citadel.org>
	* Repaired IGnorant security hole blunder re. citmail

Sun Apr 25 12:44:08 EDT 1999 Art Cancro <ajc@uncensored.citadel.org>
	* serv_chat.c: notify user of number of participants upon entering chat
	* Built the 5.53 distribution

Wed Apr 21 22:23:13 EDT 1999 Art Cancro <ajc@uncensored.citadel.org>
	* aidepost.c: add -r flag to allow posting to rooms other than Aide>
	* serv_expire.c: now posts transcripts of all auto-purged rooms/users

Tue Apr 20 12:45:55 EDT 1999 Art Cancro <ajc@uncensored.citadel.org>
	* messages.c: downloading more than MAX_MSGS messages now truncates
	  (off the beginning of the list) rather than crashing.

Mon Apr 19 12:11:48 EDT 1999 Art Cancro <ajc@uncensored.citadel.org>
	* whobbs.c: auto-detect when being called from a webserver, and act
	  as a CGI (print HTTP headers and HTML output)

1999-04-18 Nathan Bryant <bryant@cs.usm.maine.edu>
	* serv_chat.c: fixed some potential buffer overruns (thanks dme)

Wed Apr 14 21:32:28 EDT 1999 Art Cancro <ajc@uncensored.citadel.org>
	* Makefile.in: chmod 4755 citmail to prevent citmail from aborting
	  when called from sendmail due to citadel.config security check

1999-04-13 Nathan Bryant <bryant@cs.usm.maine.edu>
	* dynloader.c: OpenBSD places underscores in front of symbol names
	* Makefile.in: fixed a few sillies
	* aidepost.c, citmail.c, file_ops.c, logging.c, msgbase.c, netmailer.c,
	  netproc.c, rcit.c, routines.c, serv_upgrade.c: fixed time_t handling
	  (have to cast it to long for printf/scanf)

Mon Apr 12 22:13:26 EDT 1999 Art Cancro <ajc@uncensored.citadel.org>
	* aidepost.c: rewrote to unlink temp file before writing to it so that
	  it will automatically go away if interrupted. Also ran indent -kr -i8

1999-04-12 Nathan Bryant <bryant@cs.usm.maine.edu>
	* configure.in, Makefile.in: taught it how to generate OpenBSD shared
	  libraries
	* config.c, sysdep.c: fix -h option not setting proper modules dir
	* configure.in, citadel.spec: make --enable-chkpwd the default
	* setup.c: don't chown chkpwd

1999-04-11 Nathan Bryant <bryant@cs.usm.maine.edu>
	* configure.in: another OpenBSD fix, but we're still not quite there yet
	* serv_chat.c: warning fix

Thu Apr  8 22:51:28 EDT 1999 Art Cancro <ajc@uncensored.citadel.org>
	* config.c: now requires a setup run for *any* rev level difference
	* Updated docs & confs for 5.53b1 release
	* setup.c: sets the 0600 permission bits on citadel.config that
	  is checked for in config.c

1999-04-08 Nathan Bryant <bryant@cs.usm.maine.edu>
	* citserver.c: improved is_public_client(), also if a public_client
	  only supplies a numeric address, attempt to resolve it
	* locate_host.c: verify that the forward DNS matches the reverse
	* locate_host.c, locate_host.h: more general interface
	* configure.in, acconfig.h: fixes for Digital UNIX

Wed Apr  7 21:36:16 EDT 1999 Art Cancro <ajc@uncensored.citadel.org>
	* Implemented "access level required to create rooms" (client & server)

1999-04-07 Nathan Bryant <bryant@cs.usm.maine.edu>
	* configure.in: updated help messages, OpenBSD support
	* setup.c: if /etc/inittab doesn't exist, don't ask to create an
	  entry in it
	* server.h, sysdep.c: fix a potential deadlock/data corruption bug
	* room_ops.c: fixed the 'gdbm error: Illegal data' message when
	  deleting a room which had never been posted to
	* user_ops.c: include errno.h
	* dynloader.c: fix for OpenBSD

1999-04-06 Nathan Bryant <bryant@cs.usm.maine.edu>
	* Makefile.in, configure.in, getutline.c, sysdep.c:
	  fixes/bug workarounds for FreeBSD

1999-04-03 Nathan Bryant <bryant@cs.usm.maine.edu>
	* Makefile.in, configure.in, chkpwd.c, acconfig.h: support for
	  `chkpwd', a setuid helper program for machines which use shadow
	  passwords (configure --enable-chkpwd)
	* Makefile.in, configure.in, auth.c, citadel.pam, user_ops.c: support
	  for PAM or shadow passwords (configure --with-pam)
	* Makefile.in: made some messages simpler
	* citadel.spec: updated for 5.53; correct name of tarball; build with
	  --enable-chkpwd and --with-pam; add defattr tags so rpm's can be
	  built by non-root user
	* commands.c: cosmetic cleanup
	* config.c: (security/paranoia) check permissions on citadel.config
	* configure.in: check for ncurses if we can't find curses
	* dynloader.c: warning fix
	* sysdep.c: don't complain if initgroups() fails
	* citadel.c: fix systems with SYSV-style signal handling (e.g. libc5)
	* Makefile.in: New! Improved! Cleaner! Shinier!

Sun Mar 21 14:21:47 EST 1999 Art Cancro <ajc@uncensored.citadel.org>
	* messages.c: cosmetic cleanups to message reading loop

Sat Mar 13 21:33:19 EST 1999 Art Cancro <ajc@uncensored.citadel.org>
	* commands.c: use bright colors by default in color mode
	* citserver.c: initialize wholist fields with (not logged in) etc.

1999-03-08 Nathan Bryant <bryant@cs.usm.maine.edu>
	* sysdep.c: call DLoader_Init() with an absolute path so that gdb can
	  find module symbols
	* database.c: bail out if opening databases fails

Sat Mar  6 01:55:55 EST 1999 Art Cancro <ajc@uncensored.citadel.org>
	* serv_chat.c: use memfmout(), *not* cprintf() to transmit express
	  messages.  Calling cprintf() on strings >256 bytes crashes the server
	* msgbase.c: minor logging fix in save_message()

1999-03-05 Nathan Bryant <bryant@cs.usm.maine.edu>
	* sysdep.c: add undocumented -r flag to citserver to prevent it from
	  dropping root permissions.
	* sysdep.c: also drop supplementary groups

1999-03-04 Nathan Bryant <bryant@cs.usm.maine.edu>
	* config.c: error checking in put_config()
	* setup.c: chgrp files to the login group associated with BBSUID
	* sysdep.c: copyright 1987-1999; drop root perms; load modules and call
	  master_startup() after dropping perms

Wed Mar  3 00:00:55 EST 1999 Art Cancro <ajc@uncensored.citadel.org>
	* Prevent buffer overruns in lowercase_name in [get|put]user()
	* client_chat.c: use citedit() for page composition

Sat Feb 27 07:47:36 EST 1999 Art Cancro <ajc@uncensored.citadel.org>
	* rooms.c: download_to_local_disk() prompts for a filename if a blank
	  filename was supplied to it (for attachments without names)
	* mime_parser.c: strip leading whitespace in content_type & disposition

1999-02-24 Nathan Bryant <bryant@cs.usm.maine.edu>
	* configure.in: improved check for pthreads
	* configure.in, routines.c, acconfig.h: check for ut_type in struct utmp
	* configure.in, Makefile.in: support for building server modules as
	  relocatable objects for BSDI (which still uses a.out *gag* *choke*)
	* configure.in: compiler choice & flags for BSDI; check for libtermcap
	* database.c: don't use a critical section in open_databases()
	* housekeeping.c: use getfloor()/putfloor() instead of
	  lgetfloor()/lputfloor() in check_ref_counts()
	* mime_parser.c: include <errno.h>
	* msgbase.c: include <limits.h>
	* sysdep.c: hacks for BSDI. use signals to fake thread cancellation;
	  don't call master_cleanup() directly from signal handler.
	* routines.c: prototype getutline() if necessary
	* getutline.c: stupid bugfix
	* acconfig.h, configure.in, locate_host.c, server.h: work around
	  nonreentrant gethostbyaddr() on BSDI

Mon Feb 15 22:59:00 EST 1999 Vaggelis Tsirkas
	* citadel.c: increased hostname buffer size to handle very big names

1999-02-15 Nathan Bryant <bryant@cs.usm.maine.edu>
	* sysdep.c(main): initialize alen before call to accept()

1999-02-04 Nathan Bryant <bryant@cs.usm.maine.edu>
	* configure.in: improved check for cygwin
	* configure.in, routines.c: access utmp directly instead of calling
	  `who' if getutline() is available.
	* configure.in, Makefile.in, getutline.c: replace getutline() on
	  systems which don't have it
	* routines.c: now always access utmp directly unless we can't find
	  utmp.h

1999-02-02 Nathan Bryant <bryant@cs.usm.maine.edu>
	* Fixes for Cygwin:
	  - ifdef out file download methods that require named pipes (client)
	  - include pthread.h and gdbm.h only if they are present (fixes
	    auto dependency generation)
	  - include snprintf.h where needed
	  - handle .exe suffixes for "make install"

Tue Feb  2 22:15:08 EST 1999 Art Cancro <ajc@uncensored.citadel.org>
	* Overhauled the express messaging system (again)

Mon Feb  1 19:48:04 EST 1999 Art Cancro <ajc@uncensored.citadel.org>
	* messages.c: implemented client download of MIME attachments

Sun Jan 31 18:29:18 EST 1999 Art Cancro <ajc@uncensored.citadel.org>
	* Added qpdecode.c to the distribution (decodes quoted-printable)
	* Finished the MIME parser
	* Gave MSG0 a reasonable behaviour for MIME messages
	* Added the OPNA command for downloading attachments

Sat Jan 30 18:39:53 EST 1999 Art Cancro <ajc@uncensored.citadel.org>
	* Look for citadel.rc in current directory if not found elsewhere
	* More work on the MIME parser
	* Added base64.c to the distribution

1999-01-29 Nathan Bryant <bryant@cs.usm.maine.edu>
	* fixes for IRIX (thanks to wr and family for use of the Indy):
	  - use memset()/memcpy() instead of bzero()/bcopy() in all cases
	  - configure updates
	  - handle `long' pid's
	  - a few other little bits

Mon Jan 25 21:23:07 EST 1999 Art Cancro <ajc@uncensored.citadel.org>
	* Fixed bug in save_message() which crashed the server on mail to sysop
	* Rewrote pop_march() to be smarter about <G>oto heuristics

Sat Jan 23 14:32:19 EST 1999 Art Cancro <ajc@uncensored.citadel.org>
	* Changed internal storage of express messages from a linked list to
	  a single, resizable buffer.
	* Added a "room order" key to the room record, to allow some control
	  over room listing order.
	* Made the room list commands aware of the room order key.
	* Overhauled <G>oto heuristics to pay attention to floor & room order

Wed Jan 20 19:21:51 EST 1999 Art Cancro <ajc@uncensored.citadel.org>
	* Added some more code to the unfinished MIME parser
	* Changed module loading path to simply "modules" because after calling
	  get_config(), the cwd is guaranteed to be the correct BBS directory.

Tue Jan 19 21:28:29 EST 1999 Art Cancro <ajc@uncensored.citadel.org>
	* Fixed a bug in the user editing command (client side)
	* Started a rewrite of the MIME parser

Thu Jan 14 21:21:15 EST 1999 Art Cancro <ajc@uncensored.citadel.org>
	* Brought over the mime_parser from WebCit and began preliminary work
	  on supporting MIME format messages.

Tue Jan 12 22:30:00 EST 1999 Art Cancro <ajc@uncensored.citadel.org>
	* Various changes to begin work on support for MIME messages
		- Defined format type 4 for MIME
		- msgbase.c: *temporary* hacks in output_message() for Type 4
		- citmail.c: added more robust header parsing, and support
		             for Type 4.  Also eliminated the crappy built-in
		             SMTP server.
		- Updated some of the technical documentation

Sun Jan 10 13:34:36 EST 1999 Art Cancro <ajc@uncensored.citadel.org>
	* Fixed access to page log room

Fri Jan  8 12:35:09 EST 1999 Art Cancro <ajc@uncensored.citadel.org>
	* control.c: include <limits.h> to fix PATH_MAX undefined
	* serv_chat.c: made the following changes to cmd_sexp() --
		* Send zero-length message to check only, don't send
		* Send "-" message on the command line to invoke
		  the SEND_LISTING transfer mode for a multi-line message
	* Added facilities to log all pages to a room (site configurable)

Tue Jan  5 23:24:52 EST 1999 Art Cancro <ajc@uncensored.citadel.org>
	* Replaced all occurances of malloc(), realloc(), and free() in the
	  server and server-modules with mallok(), reallok(), and phree().
	  Wrote macros and a set of leak-tracking functions.

Sun Jan  3 20:38:45 EST 1999 Art Cancro <ajc@uncensored.citadel.org>
	* Documentation changes

Fri Jan  1 01:01:45 EST 1999 Art Cancro <ajc@uncensored.citadel.org>
	* Fixed security problem relating to private rooms

Wed Dec 30 20:10:52 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* sysdep.c: put a bigger string buffer into lprintf() to avoid overruns

Sat Dec 26 16:56:46 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* internetmail.config: commented this file more clearly

Wed Dec 23 20:42:49 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* citadel.c: added some experimental code to automatically reconnect
	  to the server if the connection is broken.  For some reason, it only
	  works once.

Wed Dec 23 18:47:12 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* sysdep.c: ignore SIGPIPE.  This keeps broken connections from
	  crashing the whole server.
	* Tagged everything for the official 5.50 release.

Mon Dec 21 07:54:20 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* housekeeping.c: call kill_session() with session_to_kill,
	  not ccptr->cs_pid (was crashing the server)

Sat Dec 19 13:57:48 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Added "-i" flag to netproc to make it skip the export phase.
	  Updated other programs to call netproc in this way when appropriate.
	* Updated network.txt to reflect the usage for netproc (which has
	  been wrong for several releases)

Thu Dec 17 00:17:04 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Started removing the word "beta" from the docs and code.
	  Preparing for an actual release.
	* msgbase.c: generate an 'I' field when requested (i.e. on locally
	  originating messages.  this was breaking parts of the network)

1998-12-15 Art Cancro <ajc@uncensored.citadel.org>
	* msgbase.c: remove extra call to alias() which was causing
	  Citadel-to-Citadel mail to fall into the bit bucket.
	* msgbase.c: fixed tempfile naming problem that could cause a new
	  outgoing netmail message to overwrite another if netproc had not been
	  run in between

1998-12-14 Art Cancro <ajc@uncensored.citadel.org>
	* More session table stability nonsense

Sun Dec 13 17:40:08 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* sysdep.c, citserver.c: (hopefully) fixed a session table concurrency
	  bug which was causing the server to occasionally crash.
	* removed serv_test.so from the default build

Fri Dec 11 18:50:00 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* setup.c: default value for maxsessions is now 0 (no limit)
	* room_ops.c: don't allow users to create a room called "Mail"
	* serv_expire.c: fixed "number of messages purged" display
	* commands.c: when using color, default to low-intensity colors

Tue Dec  8 07:58:16 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Beta 2

Sat Dec  5 01:24:03 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Added a new type of module hook for adding logging functions
	* Removed whitespace to left and right of '@' in netmail recipients
	* sysdep.c: read citadel.config _before_ initializing loadable modules
	* stats.c: fixed segfault resulting from extracting log lines
	* Ripped most of the "attachments" stuff out of both the client and
	  server.  (Thought of a better way to handle it ... LATER.)

1998-12-03 Nathan Bryant <bryant@cs.usm.maine.edu>
	* setup.c: create citadel.config with mode 0600
	* Makefile.in: don't chmod sendcommand
	* serv_upgrade.c: don't create citadel.config if it doesn't already
	  exist (paranoia)
	* setup.c: saner defaults for nodename and fqdn

Wed Dec  2 20:37:05 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* msgbase.c: modified AddMessageToRoom() and all functions that call it
	  to use a more reliable/accurate method to set quickroom.QRhighest
	* weekly.in: don't sort/purge filedir where filedir doesn't exist

1998-12-02 Nathan Bryant <bryant@cs.usm.maine.edu>
	* weekly is now generated by configure

Mon Nov 30 19:48:52 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* room_ops.c: added sort_msglist() to move and save operations
	* sendcommand.c: added (also updated utils.txt, weekly, Makefile.in)
	* BETA 1

Sun Nov 29 23:57:39 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Fixed cmd_regi() to not display a second result code after xfer
	* Makefile.in: Removed "chmod 4755 citmail netmailer"

1998-11-23 Nathan Bryant <bryant@cs.usm.maine.edu>
	* citadel.spec: added

1998-11-22 Nathan Bryant <bryant@cs.usm.maine.edu>
	* Makefile.in: split install target into install-exec, install-data,
	  and install-doc subtargets

Sat Nov 21 16:53:30 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Added a fourth color mode in the client: "user" which turns color
	  on or off according to a per-user flag stored on the server.  Added
	  server-side support for this too, of course.
	* import.c: removed
	* serv_expire.c: finished the code to purge stale visits
	* sysdep.c: strip trailing nonprintables in client_gets()
	* routines2.c: fixed <.AS> command; all configs now work properly
	* Moved num_parms() and all the extract() type functions into tools.c
	  and removed them from all other files.  Linked in tools.[o|ro] there.
	* netproc.c: handled incoming file transfers to correct room directory
	* room_ops.c: fixed incorrect naming of files in info and images dirs

Fri Nov 20 20:29:07 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* setup.c: removed all prompts that can be configured from within the
	  client in order to simplify the setup procedure

Thu Nov 19 23:28:33 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Fixed serv_upgrade.c and export5.c (found elsewhere) to use a new
	  export format which treats visits as a separate section
	* serv_expire.c: began writing functions to purge rooms and visits
	  (neither work yet), and added a way to call defrag_databases()

Wed Nov 18 23:51:17 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Reimplemented 'visit' structs stored globally instead of as
	  lists-per-user

Tue Nov 17 22:37:48 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Started implementing global room numbers.

Sun Nov 15 20:32:34 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* room_ops.c: mailbox rooms always appear on the main floor
	* made QR_MAILBOX rooms non-editable
	* cmd_setr() delete old room record when room name changes
	  (This causes a big mess that exposes a flaw in the whole design.)
	* room_ops.c: users can delete messages from their mailboxes

Thu Nov 12 23:59:13 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Rewrote cmd_rchg() and also increased the size of the "fakename"
	  buffer.  Overruns are probably what was causing the crashes.
	* Changed the way cmd_ent3() handles mail messages; the previous code
	  rerouted all private mail to the trash.

Wed Nov 11 17:57:39 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* citserver.c: slight changes to cmd_rchg() and cmd_hchg() [crashes]
	* citserver.c, msgbase.c, user_ops.c: hide the owner-prefix of mail
	  rooms in a couple more places: set_wtmpsupp() and make_message()
	* sysdep.c: added an fflush() to lprintf() for "tail -f"-able logs
	* serv_expire.c: purge ops are now a command instead of a cleanup
	  function.  This is probably temporary as well.
	* citadel.c: fixed the way <.WL> parses the returned data from a
	  TIME command.

1998-11-11 Nathan Bryant <bryant@cs.usm.maine.edu>
	* serv_upgrade.c: fix uninitialized variable

Wed Nov 11 00:47:32 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* msgbase.c: fixed a bug that was misrouting incoming network msgs
	* server.h, database.c: wrapped all GDBM calls in critical sections
	  to avoid making those calls re-entrantly (gdbm fatal: lseek error)

1998-11-10 Nathan Bryant <bryant@cs.usm.maine.edu>
	* Makefile.in: link in snprintf.o where needed

1998-11-09 Nathan Bryant <bryant@cs.usm.maine.edu>
	* client_chat.c: eliminate calls to sprintf()
	* commands.h, routines.c, routines2.c: warning fix
	* commands.c, control.c, cux2ascii.c, file_ops.c, import.c,
	  ipc_c_tcp.c: eliminate sprintf() calls

Mon Nov  9 19:15:31 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* serv_upgrade.c: added all missing fields to export/import
	* serv_expire.c: support per-user purge time when purging users
	* user_ops.c: added per-user purge time to AGUP and ASUP commands
	* routines.c: added more stuff to <.A>ide <E>dit user

Sun Nov  8 22:56:53 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* serv_expire.c: created; moved message expiry from serv_test.c,
	  moved user purge from userpurge.c
	* userpurge.c: deleted
	* routines2.c: finished <.AS> command
	* room_ops.c: fixed Aide room access (for some reason, the Aide
	  room had the QR_MAILBOX flag set)

1998-11-08 Nathan Bryant <bryant@cs.usm.maine.edu>
	* useradmin.c: really removed (cvs remove)
	* aidepost.c, citadel.c: convert all sprintf() calls to snprintf()
	* sysdep.c: fix overrun in lprintf() described by dme/Dead Monkey
	* citmail.c, citserver.c: convert all sprintf() call to snprintf()

Sun Nov  8 13:19:36 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* useradmin.c: removed
	* utils.doc: removed references to useradmin and sysoputil

Fri Nov  6 20:22:20 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* citadel.h (and related files): removed defunct parameters,
	  c_defent and c_msgbase (erase your test bbs)
	* Implemented CONF server command for site-global configs
	* Shuffled yesno() and yesno_d() from routines.c to commands.c
	* commands.c: implemented boolprompt()
	* routines2.c: started adding CONF questions to <.AS> command
	* room_ops.c: began a fix for the mysterious disappearing Aide room

1998-11-05 Nathan Bryant <bryant@cs.usm.maine.edu>
	* snprintf.c: warning fix propagated over from gcit

1998-11-04 Nathan Bryant <bryant@cs.usm.maine.edu>
	* added RCS Id keyword strings to sources
	* citmail.c: reverted to version 1.10

Wed Nov  4 10:53:13 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* messages.c: temporarily set screenwidth to a fixed value of 80
	  during <P>rint operations.

Mon Nov  2 12:59:03 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* setup.c: looks for 'citadel', 'bbs', or 'guest' in /etc/passwd to
	  try to get a default for bbsuid if it's currently set to 0
	* citmail.c: changed usersupp.eternal to usersupp.usernum (why didn't
	  it complain about this before?)
	* serv_upgrade.c: began writing an "export" command to do sidegrades

Sun Nov  1 18:47:42 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* serv_upgrade.c: cosmetic changes
	* Implemented message expiry by date (this really needs to be moved
	  out of serv_test.c, but where does it belong?)

1998-11-01 Nathan Bryant <bryant@cs.usm.maine.edu>
	* serv_upgrade.c: warning fixes
	* acconfig.h: remove ANSI_COLOR
	* Configure, Makefile.tmpl: removed

Sat Oct 31 20:48:44 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* More stoopid ANSI colour additions here and there.
	* ANSI colour selection is now in citadel.rc instead of an option in
	  the configure script.  "on" "off" and "auto" are available.
	* added "build.txt" to the techdoc directory, with LS's build notes

1998-10-31 Nathan Bryant <bryant@cs.usm.maine.edu>
	* citadel.c, commands.c, commands.h: set background color to black
	  before clearing screen, so that we can actually see text on
	  black-on-white xterms.

1998-10-29 Nathan Bryant <bryant@cs.usm.maine.edu>
	* rooms.c: fix color of Mail>
	* citadel.c: send ANSI detect sequence after attach_to_server() so the
	  terminal doesn't send the answerback sequence to the shell if we
	  can't connect.

Wed Oct 28 20:20:14 EST 1998 Art Cancro <ajc@uncensored.citadel.org
	* citadel.c: Added a splash of colour to the Wholist

1998-10-28 Nathan Bryant <bryant@cs.usm.maine.edu>
	* configure.in: added comments
	* mkinstalldirs: new file to be used for `make install'
	* aclocal.m4, missing: new files, also swiped from automake
	* citadel.c: don't mung the terminal if we can't find citadel.rc
	* Makefile.in: added `install' target, `clean' removes
	  *.mo, rebuild configure when configure.in changes.
	* configure.in: check for install and autoconf
	* configure.in, Makefile.in: only pass -fPIC to gcc
	* policy.c: warning fix for OSF/1 (use memset() instead of bzero())

Tue Oct 27 22:25:42 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Unified the "unpacked database" format for both upgrades and
	  sidegrades (also see export5.c elsewhere)
	* citserver.c: clear out cmdbuf before reading a command; some server
	  commands were accidentally extracting parameters from previous cmds
	* rooms.c: removed the warning about the ineffectiveness of kicking
	  users out of public rooms, because the new server can do lockouts

1998-10-27 Nathan Bryant <bryant@cs.usm.maine.edu>
	* sysdep.c (client_gets), ipc_c_tcp.c (serv_gets): improved handling
	  of long lines. 
	* Makefile.in: partial support for VPATH builds, autodependency fix

Tue Oct 27 00:08:16 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* minor documentation changes

Sun Oct 25 14:57:40 EST 1998 Art Cancro <ajc@uncensored.citadel.org>
	* messages.c: fixed an oversight that was allowing attachments even
	  when disabled in citadel.rc

1998-10-25 Nathan Bryant <bryant@cs.usm.maine.edu>
	* routines2.c: warning fix

Sat Oct 24 22:07:56 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Client: added message expiration policy questions to room edit
	* Client: added <.A>ide <S>ystem configuration command

1998-10-24 Nathan Bryant <bryant@cs.usm.maine.edu>
	* Makefile.in: Auto dependency generation (may require GNU make, but
	  does at least function without this feature on OSF/1 make);
	  Makefile is regenerated when Makefile.in changes (ditto);
	  `realclean' is now known as `distclean';
	  portability fixes for older Unix make utilities
	* citadel.c, citadel.h, commands.c: make client suspendable

Fri Oct 23 19:34:38 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* setup.c: default node name is now obtained from uname()
	* config.c: added put_config()
	* policy.c: added, moved GetExpirePolicy() from room_ops.c
	* policy.c: implemented cmd_gpex() and cmd_spex()

Wed Oct 21 22:24:48 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Mail rooms now hide their owner-prefix from the client.
	* proxy.c: added configurability and primitive message expiry

1998-10-20 Nathan Bryant <bryant@cs.usm.maine.edu>
	* Makefile.tmpl: fix to build client with old Configure script
	* configure.in: autologin defaults to enabled if crypt() is available
	* room_ops.c: fix improper null-termination bug I introduced

Mon Oct 19 20:52:55 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Client ability to force display of prompts in Mail rooms, even when
	  the user has prompting turned off (citadel.rc option)

1998-10-16 Nathan Bryant <bryant@cs.usm.maine.edu>
	* sysdep.c (cprintf): generate a newline on truncated buffer
	* room_ops.c: exploitable overrun fixes

Thu Oct 15 19:27:32 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* msgbase.c: reimplemented cmd_move()
	  room_ops.c: wrote AddMessageToRoom() which is used for both entering
	  and moving messages.
	* setup.c: system-default message expire policy of "number of
	  messages, 150" is now a default configuration instead of a temp hack
	* proxy.c: cache dir create now dies on any error except EEXIST

Wed Oct 14 22:41:16 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Misc code cleanup

1998-10-13 Nathan Bryant <bryant@cs.usm.maine.edu>
	* configure.in: don't check for -lcrypt unless autologin is enabled
	* file_ops.c: fix another overrun

Mon Oct 12 15:27:21 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Killed the "rooms" subdirectory (it isn't used anymore)
	* dynloader.c: Made dynamically added server commands case-insensitive
	* import.c is now serv_upgrade.c, a module
	* Removed most of the "level 9" trace messages no longer needed

1998-10-12 Nathan Bryant <bryant@cs.usm.maine.edu>
	* Makefile.in: simplified to use pattern rules; files compiled with
	  -D_REENTRANT go to *.ro to allow the same files to be used with both
	  client and server
	* tools.c, tools.h: new files; misc routines used by both client and
	  server go here. contains safestrncpy() at the moment.
	* rooms.c: fix several exploitable buffer overruns
	* sysdep.c: fix infinite loop when long lines are received from the
	  client; fix exploitable buffer overrun in cprintf()
	* ipc_c_tcp.c: fix infinite loop on long line from server
	* serv_upgrade.sh: remove uncnsrd-dependent absolute path
	* .cvsignore: add *.ro

Sun Oct 11 23:17:48 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Built some more of the message expiry infrastructure

1998-10-11 Nathan Bryant <bryant@cs.usm.maine.edu>
	* citserver.c: fix two more overruns, one of which was preventing
	  the "From Host" from showing up in the <W>ho listing.

Sun Oct 11 02:51:55 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Moved "struct visit" and its associated defs from citadel.h to
	  server.h where they belong
	* Set up data structures for room policies (expiry, etc.)

1998-10-10 Nathan Bryant <bryant@cs.usm.maine.edu>
	* citserver.c: fix overrun which caused segv's on servers with long
	  hostnames.

Fri Oct  9 18:34:06 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* user_ops.c: added PurgeStaleRelationships() to do processing at
	  session logout time to remove visits for rooms which no longer exist
	* user_ops.c: implemented NewMailCount()

1998-10-09 Nathan Bryant <bryant@cs.usm.maine.edu>
	* serv_chat.c: fix buffer overrun that was resulting in segv's
	* serv_chat.c: fix another overrun that could cause sessions to hang,
	  and cleaned up some other strncpy()-related stuff. DON'T FORGET TO
	  NULL-TERMINATE DESTINATION BUFFERS AFTER STRNCPY CALLS.

Fri Oct  9 13:22:37 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Implemented "lazy mode" traversal - pressing the space bar will do
	  <N>ext messsage, <G>oto next room, or read <N>ew as appropriate.
	* room_ops.c: modify CtdlRoomAccess() to allow access to mailbox rooms
	  only to their owners.

Thu Oct  8 17:13:27 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* messages.c, citadel.rc: added the ability to display message numbers
	  in the header when reading messages.  I think this is butt ugly, but
	  some of the DaveCode afficionados seem to like it...

Thu Oct  8 15:34:45 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* room_ops.c: Added is_noneditable() function to replace all of the
	  duplicated code present in all functions which edit room parameters.

1998-10-08 Nathan Bryant <bryant@cs.usm.maine.edu>
	* lots of warning fixes; builds with -std1 on dec unix
	* aidepost.c, citadel.h, citmail.c, file_ops.c, msgbase.c, netmailer.c,
	  netproc.c, rcit.c, server.h, stats.c, userlist.c: use time_t where
	  needed
	* control.c, room_ops.c, serv_chat.c, sysdep.c: use memset() instead of
	  bzero()
	* dynloader.c, dynloader.h, messages.c, server.h, sysdep.c,
	  sysdep_decls.h: function pointer/prototyping fixes
	* rooms.c: use mkfifo(3) instead of system("mkfifo")

1998-10-07 Nathan Bryant <bryant@cs.usm.maine.edu>
	* snprintf.c, snprintf.h: new files
	* Makefile.in, configure.in, dynloader.c, sysdep.c: support for the
	  above; citserver now builds and runs on Digital Unix 4.0d with the
	  GNU-style configure script. there is a bug with the hostname display
	  in the wholist.
	* netproc.c: sillyness fix
	* room_ops.h: prototype delete_room()
	* client_chat.c, commands.c, serv_chat.c, sysdep.c:
	  use HAVE_SYS_SELECT_H macro

Mon Oct  5 17:01:32 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Began fixing the stuff I broke

Sun Oct  4 23:35:18 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Did the big migration to the new data structures.  Lots of stuff is
	  now broken.  Basic moving from room to room works, but Mail is
	  broken, and some of the administrative commands are unimplemented.

1998-10-02 Nathan Bryant <bryant@cs.usm.maine.edu>
	* configure.in: autologin now defaults to disabled

Fri Oct  2 00:04:31 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Finally removed all three usersupp.foo[MAXROOMS] elements, and
	  migrated all the code that used them to use "struct visit" instead.

Thu Oct  1 23:02:20 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Rewrote [l][get|put]room() functions to use room names rather than
	  room index numbers.  Temporarily prepended a "n" to these four
	  function names until they are put to use.

Thu Oct  1 16:27:13 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Removed a few more references to usersupp.lastseen[]

1998-10-01 Nathan Bryant <bryant@cs.usm.maine.edu>
	* .cvsignore: add so_locations (generated by osf1 ld with shared libs)
	* Makefile.in: restructured variables for greater consistency, use
	  @echo to print out notices during the make process, add so_locations
	  to `cleaner'
	* configure.in, Makefile.in: configure checks for -rdynamic
	* ipc_c_tcp.c: fix DEC compiler warning wrt unsigned char
	* stats.c: add semicolon to placate DREC compiler
	* user_ops.c: define _POSIX_C_SOURCE, include <limits.h>
	* configure.in: pass -pthread to DEC compiler, don't check for
	  libpthread[s] on DEC Unix

1998-09-30 Nathan Bryant <bryant@cs.usm.maine.edu>
	* Makefile.in: new variable PTHREAD_DEFS for portability
	* aidepost.c, citadel.c, citmail.c, mailinglist.c, msgform.c,
	  netmailer.c, netpoll.c, netproc.c, rcit.c, readlog.c, setup.c,
	  stats.c, userlist.c, whobbs.c: return type of main() is int
	* citadel.c, commands.c, messages.c: use time_t properly
	* citserver.c: include <limits.h>
	* config.guess, config.sub, install-sh: new files
	* configure.in: don't use gcc on Digital Unix

Tue Sep 29 23:17:34 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* room_ops.c: modified usergoto() to look at the new data structures
	  for counting new messages and such.

1998-09-29 Nathan Bryant <bryant@cs.usm.maine.edu>
	* user_ops.c: fix compiler warning and potential memory leak,
	  include sysdep.h
	* configure.in, Makefile.in: only build the server if we find pthreads
	* Makefile.in: realclean removes config.{cache,log,status}

Tue Sep 29 13:20:14 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Removed code from some of the utilities which was still attempting
	  to access the old non-gdbm data store.
	* housekeeping.c: rewrote check_ref_counts() to do a ForEachRoom()
	  traversal instead of a MAXROOMS loop.
	* sysdep.c: set up a dummy CitContext record to be used during server
	  startup, during which time there is no real context.

Mon Sep 28 23:51:51 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Implemented the function ForEachRoom() to handle all-rooms traversal
	  (this will work with both the old and new paradigms, because both
	  use a GDBM database with one room per record).  Migrated all room
	  list commands to use it.

Mon Sep 28 22:05:35 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Implemented the function CtdlRoomAccess() to handle *all* of the
	  user-access-to-rooms functionality.  Migrated all room list commands
	  to use it.  Still need to migrate gotos.

1998-09-28 Nathan Bryant <bryant@cs.usm.maine.edu>
	* configure.in, acconfig.h: new files; partially functional GNU
	  autoconf configure script. Run autoheader; autoconf; ./configure
	  --prefix=`pwd` to test.
	* Makefile.tmpl: new file; this is what Makefile.in used to be. Used by
	  Configure.
	* Makefile.in: modified to work with autoconf-style configure script
	* Configure: modified to use Makefile.tmpl and generate autoconf-style
	  macros. Removed procfs detection. Pass -O2 to gcc, -O to other
	  compilers. Removed mknod/mkfifo detection; code should use mkfifo(3).
	* citmail.c, msgform.c, netproc.c, routines.c, support.c, userlist.c,
	  whobbs.c: use HAVE_STRERROR macro rather than NO_STRERROR
	* commands.c: use HAVE_TERMIOS_H macro rather than POSIX_TERMIO
	* netproc.c: remove procfs stuff. simply attempt to kill the target
	  process with signal zero instead; this checks whether the process
	  exists.
	* setup.c, useradmin.c: use HAVE_CURSES_H macro

Sun Sep 27 23:41:29 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* BOTH the old and new generation systems are being written to at
	  this point.  Code that reads stuff is still using the old system.

Sun Sep 27 16:10:49 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Changed all "generation" variables from char to long, in preparation
	  for removing MAXROOMS.  Generations for new rooms are now timestamps.
	* Defined "struct visit" to hold user/room relationships.
	* Removed some #define's from citadel.h that are no longer used.

Wed Sep 23 13:41:49 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* More changes to support attachments.  They mostly work, but only
	  in fixed-format messages.

Mon Sep 21 21:19:17 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* msgbase.c: began laying the groundwork to support attachments.
	  Purchased Rogaine(tm) in preparation for expected hair loss.

1998-09-21 Nathan Bryant <bryant@cs.usm.maine.edu>
	* msgbase.c: include dynloader.h
	* citadelapi.h: removed
	* dynloader.h: prototype CtdlRegisterUserHook()

Sun Sep 20 18:56:37 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Added a UserFunctionHook category to implement hooks which perform
	  operations on various users or usernames

Fri Sep 18 21:14:41 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* citserver.c: removed cmd_extn() and related code

1998-09-18 Nathan Bryant <bryant@cs.usm.maine.edu>
	* user_ops.c: include dynloader.h
	* roomstats.{c,mk}: removed
	* Configure, Makefile.in: autodependency-related fixes

Thu Sep 17 22:55:29 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Various changes to allow "new messages" to work correctly with Mail

Thu Sep 17 22:21:45 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* server.h, dynloader.c, citserver.c, user_ops.c: reduced the number
	  of hook types by inventing an EventType field to the Session hook.
	* proxy.c: added pre-fetching

1998-09-17 Nathan Bryant <bryant@cs.usm.maine.edu>
	* Makefile.in: add SERV_MODULES and PROXY_TARGETS to `cleaner'
	* dynloader.[ch], serv_{chat,test}.[ch], sysdep.c: cleaned
	  up the dynamic loader interface as follows:
	  - all the symbol table stuff is gone.
	  - modules are loaded once at server startup and never unloaded.
	  - Added a new function CtdlRegisterProtoHook() to handle the stuff
	    that was being done with the symbol tables.
	  - Dynamic_Module_Init() now returns a pointer to a static struct
	    DLModule_Info; this structure itself has been modified to use char*
	    fields instead of fixed char arrays.
	* roomstats.c: include <stdarg.h> not <stdargs.h> (is this file still
	  in use?)
	* Configure, Makefile.in: added autodependency support

Wed Sep 16 22:25:13 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Implemented separate structs, lists, and functions for each type
	  of server-side hook available.

1998-09-16 Nathan Bryant <bryant@cs.usm.maine.edu>
	* ipc_c_tcp.c: Fixed up some #include/prototyping stuff, call memcpy()
	  instead of bcopy()
	* hooks.h: removed
	* sysdep.c, user_ops.c: removed reference to hooks.h

Wed Sep 16 11:42:42 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* ipc_c_tcp.c: Reversed any changes that have been made to this file,
	  because something was causing abominally slow response time.
	* proxy.c: added.  This will eventually become a caching, pre-fetching
	  multiuser proxy server for the Citadel protocol.

1998-09-15 Nathan Bryant <bryant@cs.usm.maine.edu>
	* Makefile.in: remove support.o from serv_chat.so, add -fPIC to compile
	  flags for serv_chat.o
	* dynloader.c: include "sysdep_decls.h", use RTLD_NOW not RTLD_LAZY
	* dynloader.h: prototype CtdlRegisterHook()
	* .cvsignore: added data

Mon Sep 14 20:49:08 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Tried my hand at adding the ability for server extensions to
	  register various types of "hooks" in addition to just adding
	  server commands.  This is probably not final.

Tue Sep  8 12:11:56 EDT 1998 Brian Costello <btx@calyx.net>
	* Added support for dynamic server modules.  Reworked serv_chat.c
	  to be such a module.

Tue Sep  1 23:09:50 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* userpurge.c: rewrote using functions from the server core, rather
	  than the now-defunct external API.  This'll be ready once the module
	  loading code is done.  (I just had to commit _something_ tonight.)

Mon Aug 31 22:47:58 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Yanked the citadelapi.c module.  This wasn't working out well.
	* techdocs/citadelapi.txt - began documenting the new API to be used
	  by modules which will be dynamic linked into the server - most of
	  this API is existing server functions.
	* Added a ForEachUser() function with callback mechanism, and reworked
	  cmd_list() to use it.

Sun Aug 30 21:52:43 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Moved all of the gdbm databases to a separate "data" directory.

1998-08-26 Nathan Bryant <bryant@cs.usm.maine.edu>
	* Makefile.in: realclean removes Makefile, fixed `touch citadel.h'
	  problem

1998-08-25 Nathan Bryant <bryant@cs.usm.maine.edu>
	* room_ops.c: include time.h
	* userlist.c, whobbs.c, serv_chat.c, user_ops.c, sysdep.c, stats.c,
	  citadel_decls.h, commands.c, messages.h, routines.h, routines2.h:
	  remove duplicated declarations

Mon Aug 24 23:45:01 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* setup.c: Removed yesno_s()
	* citadel.h, room_ops.c: added QRmtime field to struct quickroom,
	  modified whenever a room is modified or posted in.
	* citadelapi.c: Added CtdlForEachRoom() function

Mon Aug 24 20:04:04 EDT 1998 Nathan Bryant <bryant@cs.usm.maine.edu>
        * Makefile.in: new target `cleaner' does the same as `realclean' 
          without removing sysdep.h
	* proto.h: is bad. eliminate. I've moved the prototypes into several
	  header files, one per .c file

Mon Aug 24 00:45:55 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Added a CtdlGotoRoom() function to the CitadelAPI.
 
Sun Aug 23 21:47:00 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* sysoputil is finally dead!  Removed it from the build.
	* Added userpurge.c server extension (initial implementation)

Tue Aug 18 00:42:33 EDT 1998 Nathan Bryant <bryant@cs.usm.maine.edu>
	* Makefile.in: `clean' target no longer rm's sysdep.h; new target
	  `realclean' removes everything clean does, plus sysdep.h, plus
	  target binaries.
	* Configure: add -Wstrict-prototypes to CFLAGS for gcc systems
	* *.[ch]: protoized. Added several new header files containing
	  prototypes and other external declarations; many duplicated
	  declarations still should be moved to header files. proto.h must die
	  as well, IMHO.

Mon Aug 17 23:52:13 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Implemented a bunch of user account related functions in the
	  CitadelAPI library.

Mon Aug 17 20:01:18 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Fixed the crash problem.  It wasn't AGUP/ASUP, but rather a buffer
	  overrun in getuser() (thanks, Nathan).  Implemented overrun checks
	  in getuser(), getroom(), and getfloor() to prevent future problems.

Mon Aug 17 00:06:52 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Updated citmail.c with the latest stuff from the production system.
	* Implemented AGUP and ASUP commands, but AGUP crashes the server
	  after its first successful use (user-not-found's don't affect it).

Thu Aug  6 19:25:01 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Got the CitadelAPI library to the point where the server can start
	  up an extension, and the extension will connect to the server, do
	  some initialization, call a user-supplied CtdlMain(), and exit.  Also
	  hacked together a _temporary_ form of the new EXTN server command.
 
Wed Aug  5 23:02:22 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Second attempt at getting the server API started.  Now it runs
	  outside of the server and builds a connection.

Tue Aug  4 18:33:06 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Modified the appearance of Internet addresses when they arrive on
	  a Citadel system.
	* Removed the <E> field from the message format writeup in hack.txt.
	* Fixed-up citmail.c so that it doesn't try to do database lookups.

Mon Aug  3 23:01:37 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Started developing the server-side API.  This is in its very
	  initial stages.  See serverapi.c and techdoc/api.txt

1998-08-02  Nathan Bryant  <bryant@cs.usm.maine.edu>
	* Makefile.in: added config_decls.h to dependencies

Sun Aug  2 21:09:09 EDT 1998 Nathan Bryant <bryant@cs.usm.maine.edu>
	* config_defs.h: renamed to config_decls.h
	* config.c, sysoputil.c: updated to reflect the above

Sun Aug  2 18:52:05 EDT 1998 Nathan Bryant <bryant@cs.usm.maine.edu>
	* config_defs.h: new file, contains external declarations from config.c
	* config.c: moved defs to config_defs.h, use PATH_MAX from <limits.h>
	  for bbs_home_directory
	* mailinglist.c, support.c: include <string.h>
	* sysoputil.c: include <string.h>, <limits.h>, "config_defs.h", remove
	  duplicated defs, replace gets() call with fgets()
	* user_ops.c: define _XOPEN_SOURCE_EXTENDED

Sat Aug  1 18:32:52 EDT 1998 Nathan Bryant <bryant@cs.usm.maine.edu>
	* ipc_c_tcp.c: fixed order of memcpy parameters after gethostbyname

Sun Jul 19 17:26:12 EDT 1998 Nathan Bryant <bryant@cs.usm.maine.edu>
	* ChangeLog: reordered; the GNU standard is to add new entries to the
	  top.
	* .cvsignore: added userlist

Sun Jul 12 20:58:59 EDT 1998 Art Cancro <ajc@uncensored.citadel.org>
        * Finished migrating everything to the new data store.
        * Replaced the binary "calllog" with the ASCII "citadel.log"
        * Began converting broken utilities that depend on the old data store

Sat Jul 11 00:20:48 EDT 1998 Nathan Bryant <bryant@cs.usm.maine.edu>
	* Makefile.in: removed msgstats

Fri Jul 10 1998 Art Cancro <ajc@uncensored.citadel.org>
	* Initial CVS import
